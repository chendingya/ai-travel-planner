# 高德地图 API 配置指南

## 📍 为什么使用高德地图?

相比 Leaflet + OpenStreetMap,高德地图有以下优势:
- ✅ **路线规划**: 内置驾车、步行、公交等多种路线规划功能
- ✅ **中国地图优化**: 对中国境内地图数据更准确、更详细
- ✅ **实时路况**: 可显示实时交通状况
- ✅ **POI 搜索**: 丰富的兴趣点数据
- ✅ **官方支持**: 完善的中文文档和技术支持

## 🔑 如何获取高德地图 API Key

### 步骤 1: 注册账号
访问 [高德开放平台](https://console.amap.com/) 并注册账号

### 步骤 2: 创建应用
1. 登录控制台后,进入"应用管理" → "我的应用"
2. 点击"创建新应用"
3. 填写应用名称,如 "AI旅行规划系统"
4. 提交创建

### 步骤 3: 添加 Key
1. 在创建的应用下,点击"添加 Key"
2. **服务平台**: 选择 **"Web端(JS API)"**
3. **Key 名称**: 填写如 "旅行规划前端"
4. 提交创建

### 步骤 4: 获取安全密钥 (可选但推荐)
1. 点击"安全密钥"
2. 点击"获取安全密钥"
3. 复制 `securityJsCode`

### 步骤 5: 配置到项目
在 `backend/.env` 文件中添加（或完善）公开变量:

```env
PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
PUBLIC_AMAP_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
PUBLIC_AMAP_SECURITY_CODE=1a2b3c4d5e6f7g8h9i0j
```

## 📝 配置示例

```env
# backend/.env (公开部分)
PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
PUBLIC_AMAP_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6
PUBLIC_AMAP_SECURITY_CODE=1a2b3c4d5e6f7g8h9i0j
```

> 后端会根据这些 `PUBLIC_*` 变量在运行时生成 `/config.js`，前端无需再维护单独的 `.env` 文件。

## 🗺️ 功能说明

### 当前实现的功能:

1. **路线规划** (`AMap.Driving`)
   - 自动计算多个景点之间的最优驾车路线
   - 支持途经点 (waypoints)
   - 显示路线长度、预计时间

2. **标记点** (`AMap.Marker`)
   - 每个景点显示数字标记 (1, 2, 3...)
   - 蓝色标签样式,清晰易辨
   - 点击标记弹出详细信息

3. **信息窗口** (`AMap.InfoWindow`)
   - 点击标记显示景点名称
   - 显示站点编号

4. **自动适配视野**
   - 自动调整地图缩放和中心点
   - 确保所有景点都在可视范围内

### 与 LLM 集成:

后端 LLM 返回的数据格式:
```json
{
  "daily_itinerary": [
    {
      "day": 1,
      "activities": [
        {
          "location": "秋叶原",
          "latitude": 35.6984,
          "longitude": 139.7731
        }
      ]
    }
  ]
}
```

前端解析后传递给地图:
```javascript
locations = [
  { name: "秋叶原", coords: [35.6984, 139.7731] }, // [lat, lng]
  { name: "浅草寺", coords: [35.7148, 139.7967] },
]
```

## 🎨 地图样式

当前使用的地图样式: `amap://styles/fresh` (清新风格)

可选样式:
- `amap://styles/normal` - 标准样式
- `amap://styles/dark` - 暗黑风格
- `amap://styles/light` - 月光银风格
- `amap://styles/whitesmoke` - 远山黛风格
- `amap://styles/fresh` - 草色青风格 ✅ 当前
- `amap://styles/grey` - 雅士灰风格
- `amap://styles/graffiti` - 涂鸦风格
- `amap://styles/macaron` - 马卡龙风格
- `amap://styles/blue` - 极夜蓝风格
- `amap://styles/darkblue` - 靛青蓝风格
- `amap://styles/wine` - 酱籽风格

## 🔧 高级配置

### 修改路线规划策略

在 `MapView.vue` 中修改:
```javascript
const driving = new AMap.Driving({
  policy: AMap.DrivingPolicy.LEAST_TIME, // 当前: 最快路线
  // 其他选项:
  // AMap.DrivingPolicy.LEAST_DISTANCE  // 最短距离
  // AMap.DrivingPolicy.LEAST_FEE       // 最少费用
  // AMap.DrivingPolicy.LEAST_TRAFFIC   // 躲避拥堵
});
```

### 更换地图样式

在 `MapView.vue` 的 `initMap()` 中修改:
```javascript
map.value = new AMap.Map('amap-container', {
  mapStyle: 'amap://styles/dark', // 改为暗黑风格
});
```

## ⚠️ 注意事项

1. **API Key 安全**:
   - ✅ 使用环境变量,不要硬编码
   - ✅ `.env` 文件已在 `.gitignore` 中
   - ✅ 建议在高德控制台设置"域名白名单"或"IP白名单"

2. **配额限制**:
   - 个人开发者账号: 每日调用量有限制
   - 路线规划: 每日限额需查看控制台
   - 超出限额需升级套餐或申请增加配额

3. **坐标系统**:
   - 高德地图使用 **GCJ-02** 坐标系 (中国加密坐标)
   - LLM 返回的经纬度应该是 WGS-84 标准坐标
   - 高德 API 会自动处理坐标转换

4. **路线规划限制**:
   - 途经点数量有限制 (通常最多 16 个)
   - 如果景点过多,可能需要分段规划

## 🐛 常见问题

### Q: 地图不显示或显示空白?
A: 检查:
1. `.env` 文件中 `VITE_AMAP_KEY` 是否配置
2. 浏览器控制台是否有 API 加载错误
3. 高德控制台中 Key 是否正确配置为 "Web端(JS API)"

### Q: 路线不显示,只有标记点?
A: 可能原因:
1. 景点数量少于 2 个 (至少需要起点+终点)
2. 路线规划失败 (查看控制台警告)
3. 两个景点距离过远或无法规划路线

### Q: 坐标位置不准确?
A: 检查:
1. LLM 返回的经纬度是否正确
2. 经纬度顺序是否为 [latitude, longitude]
3. 前端传递给高德时是否转换为 [longitude, latitude]

## 📚 参考文档

- [高德地图 JS API 官方文档](https://lbs.amap.com/api/javascript-api/summary)
- [路线规划 API 文档](https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingOptions)
- [地图样式列表](https://lbs.amap.com/api/javascript-api/guide/create-map/map-style)
