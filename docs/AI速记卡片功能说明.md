# AI速记卡片功能说明

## 功能概述

AI速记卡片功能允许用户根据生成的旅行计划，自动创建一张精美的手绘风格旅行速记卡片。该功能集成了以下技术：

- **GitCode AI / 阿里百炼**：用于生成适合绘图的提示词
- **图片生成引擎**（支持切换）：
  - 🔵 **腾讯云混元生图**：高质量图像生成，国内稳定
  - 🟢 **魔搭社区 ModelScope**：阿里巴巴开源模型，免费额度充足

## 功能流程

1. 用户在旅行计划详情页点击"生成AI速记卡片"按钮
2. 系统跳转到速记卡片生成页面
3. **用户可选择图片生成提供商**（腾讯混元/魔搭社区）
4. 自动调用AI生成适合绘图的提示词（根据旅行计划内容）
5. 使用生成的提示词调用选定的图片生成API
6. 显示生成的图片，用户可以下载或重新生成

## 配置要求

### 1. 环境变量配置

在 `backend/.env` 文件中添加以下配置：

```env
# AI API 配置（用于生成提示词）
AI_API_KEY=your_ai_api_key_here
AI_BASE_URL=https://api.gitcode.com/api/v5
AI_MODEL=Kimi-K2

# ============ 图片生成配置（至少配置一个） ============

# 方案一：腾讯云混元生图（推荐）
TENCENT_SECRET_ID=your_tencent_secret_id_here
TENCENT_SECRET_KEY=your_tencent_secret_key_here

# 方案二：魔搭社区 ModelScope（备选）
MODELSCOPE_API_KEY=your_modelscope_api_key_here

# 默认图片生成提供商 (hunyuan 或 modelscope，可选)
# IMAGE_PROVIDER=hunyuan
```

> 💡 **提示**：两种图片生成方案可以同时配置，用户可以在页面上自由切换。

### 2. 获取腾讯云密钥

1. 访问 [腾讯云控制台](https://console.cloud.tencent.com/)
2. 进入"访问管理" -> "访问密钥" -> "API密钥管理"
3. 创建密钥并获取 SecretId 和 SecretKey
4. 确保账户已开通混元生图服务并有足够余额

### 3. 获取魔搭社区 API Key（可选）

1. 访问 [魔搭社区](https://modelscope.cn/)
2. 注册并登录账号
3. 进入 [API 密钥管理页面](https://modelscope.cn/my/myaccesstoken)
4. 创建新的 Access Token
5. 复制 API Key 到环境变量

> 💡 **魔搭社区优势**：
> - 新用户有充足的免费调用额度
> - 支持多种图像生成模型
> - 国内访问稳定，无需科学上网

### 4. 混元生图服务开通

1. 访问 [腾讯云混元生图控制台](https://console.cloud.tencent.com/aiart)
2. 开通混元生图服务
3. 了解计费规则：按次计费，每次生成约 0.1-0.2 元

## 使用说明

### 用户操作流程

1. **生成旅行计划**：在"智能规划"页面生成旅行计划
2. **查看计划详情**：进入计划详情页
3. **生成速记卡片**：点击右侧顶部"快捷操作"卡片中的"生成AI速记卡片"按钮
4. **等待生成**：系统会自动完成两个步骤：
   - 步骤1：生成提示词
   - 步骤2：调用AI绘图
6. **查看结果**：生成完成后可以：
   - 查看生成的图片
   - 下载图片到本地
   - 查看生成的提示词
   - 重新生成（如果对结果不满意）

### UI 布局变化

- **左侧**："您的专属旅行方案"卡片（移除了编辑和保存按钮）
- **右侧顶部**："快捷操作"卡片（新增）
  - 编辑行程按钮
  - 保存计划按钮（新生成的计划可见）
  - 生成AI速记卡片按钮（新功能）
- **右侧下方**：地图显示区域

## 提示词生成逻辑

系统会根据以下信息自动生成绘图提示词：

- 目的地名称
- 旅行天数
- 每日主题和主要活动
- 特色景点和美食

生成的提示词遵循以下风格：

```
画面标题：《云南漫游记·五日谈》
整体构图：垂直分层手账风格，从上至下按日期分为五个区域
每日画面元素：
Day 1：风起大理·古城初探
- 主视觉：大理古城门楼与苍山轮廓
- 细节元素：石板路、三角梅
- 美食点缀：野生菌火锅、玫瑰花茶
...
```

## 错误处理

### 常见错误及解决方案

1. **"暂无可用的图片生成服务"**
   - 至少需要配置一个图片生成提供商
   - 检查 TENCENT_SECRET_ID/KEY 或 MODELSCOPE_API_KEY 是否配置
   - 重启后端服务使环境变量生效

2. **"混元生图功能当前不可用"**
   - 检查是否配置了 TENCENT_SECRET_ID 和 TENCENT_SECRET_KEY
   - 确认环境变量已正确加载（重启服务器）

3. **"魔搭社区图片生成失败"**
   - 检查 MODELSCOPE_API_KEY 是否正确
   - 确认 API Key 未过期
   - 查看后端日志了解详细错误

4. **"腾讯云认证失败"**
   - 检查密钥是否正确
   - 确认密钥未过期且有相应权限

3. **"提示词包含违规内容"**
   - AI生成的提示词可能包含敏感词汇
   - 点击"重新生成"按钮重试
   - 如持续出现，可能需要调整提示词生成逻辑

4. **"账号已欠费"**
   - 检查腾讯云账户余额
   - 充值后继续使用

5. **"请求次数超过限制"**
   - 等待一段时间后重试
   - 或联系腾讯云提升配额

## 技术架构

### 前端部分

- **QuickNoteView.vue**：速记卡片生成页面
  - 显示加载状态和进度
  - 展示生成的图片
  - 提供下载和重新生成功能

### 后端部分

- **GET /api/image-providers**：获取可用的图片生成提供商列表
  - 输出：可用提供商数组（根据环境变量配置动态返回）

- **POST /api/generate-prompt**：生成绘图提示词
  - 输入：旅行计划数据
  - 输出：优化后的绘图提示词

- **POST /api/generate-image**：生成图片
  - 输入：
    - `prompt`: 绘图提示词
    - `provider`: 图片生成提供商（可选，默认使用第一个可用提供商）
  - 调用：腾讯云混元生图 或 魔搭社区 API
  - 输出：图片URL

### 集成的API

1. **腾讯云混元生图极速版**
   - SDK：`tencentcloud-sdk-nodejs`
   - API：`TextToImageLite`
   - 参数配置：
     - Resolution: 1024:1024
     - RspImgType: url
     - LogoAdd: 1（添加AI生成标识）

2. **魔搭社区 ModelScope**
   - 接口：REST API（异步模式）
   - 模型：`Qwen/Qwen-Image`
   - 工作流程：
     1. 发送生成请求，获取 task_id
     2. 轮询任务状态直到完成
     3. 获取生成的图片 URL

## 未来优化方向

1. **提示词优化**：根据用户反馈持续优化提示词模板
2. **样式选择**：允许用户选择不同的绘画风格
3. **更多提供商**：支持更多图片生成服务（如 Stable Diffusion、Midjourney 等）
4. **批量生成**：支持一次性生成多个不同风格的卡片
5. **历史记录**：保存用户生成过的卡片记录
6. **分享功能**：支持直接分享到社交平台

## 注意事项

1. 生成的图片包含"图片由AI生成"标识（符合监管要求）
2. 图片URL有效期为1小时，请及时下载
3. 每次生成会产生费用，请合理使用
4. 如遇到违规检测，可能是提示词包含敏感词，多试几次

## 问题反馈

如在使用过程中遇到问题，请检查：

1. 环境变量是否正确配置
2. 服务器日志中的错误信息
3. 腾讯云控制台的API调用记录
4. 网络连接是否正常

---

更新时间：2025年11月28日
