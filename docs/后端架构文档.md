# AI æ—…è¡Œè§„åˆ’ç³»ç»Ÿ - åç«¯æ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•

- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æŠ€æœ¯æ ˆ](#æŠ€æœ¯æ ˆ)
- [ç›®å½•ç»“æ„](#ç›®å½•ç»“æ„)
- [æ ¸å¿ƒæ¶æ„è®¾è®¡](#æ ¸å¿ƒæ¶æ„è®¾è®¡)
- [æ¨¡å—è¯¦è§£](#æ¨¡å—è¯¦è§£)
- [AI æœåŠ¡é›†æˆ](#ai-æœåŠ¡é›†æˆ)
- [MCP å·¥å…·é›†æˆ](#mcp-å·¥å…·é›†æˆ)
- [API è·¯ç”±è®¾è®¡](#api-è·¯ç”±è®¾è®¡)
- [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [éƒ¨ç½²æŒ‡å—](#éƒ¨ç½²æŒ‡å—)

---

## ç³»ç»Ÿæ¦‚è¿°

### é¡¹ç›®å®šä½
AI æ—…è¡Œè§„åˆ’ç³»ç»Ÿï¼ˆæ‹¾å…‰ç»˜æ—…ï¼‰æ˜¯ä¸€ä¸ªåŸºäº AI çš„æ™ºèƒ½æ—…è¡Œè§„åˆ’ Web åº”ç”¨çš„åç«¯æœåŠ¡ï¼Œé‡‡ç”¨ç°ä»£åŒ–æŠ€æœ¯æ ˆå’Œæ¨¡å—åŒ–è®¾è®¡ï¼Œæä¾›çµæ´»çš„ AI æœåŠ¡é›†æˆå’Œå¼ºå¤§çš„æ—…è¡Œè§„åˆ’åŠŸèƒ½ã€‚

### æ ¸å¿ƒç‰¹æ€§
- âœ… **ç»Ÿä¸€çš„ AI æœåŠ¡ç®¡ç†**ï¼šé€šè¿‡ LangChain ç»Ÿä¸€ç®¡ç†å¤šä¸ª AI æä¾›å•†
- âœ… **å¤šæä¾›å•†é™çº§ç­–ç•¥**ï¼šæ”¯æŒå¤šä¸ªæ–‡æœ¬/å›¾ç‰‡æä¾›å•†çš„è‡ªåŠ¨é™çº§
- âœ… **MCP å·¥å…·é›†æˆ**ï¼šé›†æˆ MCPï¼ˆModel Context Protocolï¼‰å·¥å…·é“¾
- âœ… **æ™ºèƒ½æ—…è¡Œè§„åˆ’**ï¼šåŸºäº AI çš„è¡Œç¨‹ç”Ÿæˆå’Œé¢„ç®—ç®¡ç†
- âœ… **å¤šåª’ä½“ç”Ÿæˆ**ï¼šæ”¯æŒå›¾ç‰‡ç”Ÿæˆã€è¯­éŸ³åˆæˆã€æ­Œå•æ¨èç­‰
- âœ… **ä¼šè¯ç®¡ç†**ï¼šåŸºäº Supabase çš„ç”¨æˆ·è®¤è¯å’Œæ•°æ®æŒä¹…åŒ–
- âœ… **é”™è¯¯è¿½è¸ª**ï¼šå®Œæ•´çš„é”™è¯¯å¤„ç†å’Œè¿½è¸ªæœºåˆ¶

---

## æŠ€æœ¯æ ˆ

### æ ¸å¿ƒæ¡†æ¶
- **Express.js 5.x** - Web åº”ç”¨æ¡†æ¶
- **Node.js >= 18.0.0** - è¿è¡Œæ—¶ç¯å¢ƒ

### AI & LangChain
- **LangChain 1.2.x** - AI åº”ç”¨å¼€å‘æ¡†æ¶
- **LangGraph 1.1.x** - æœ‰çŠ¶æ€ AI åº”ç”¨çš„å›¾è¡¨ç¤ºæ¡†æ¶
- **@langchain/core 1.1.x** - LangChain æ ¸å¿ƒåº“
- **@langchain/openai 1.2.x** - OpenAI é›†æˆ
- **@modelcontextprotocol/sdk 1.23.x** - MCP SDK

### æ•°æ®å­˜å‚¨
- **Supabase.js 2.86.x** - PostgreSQL æ•°æ®åº“å®¢æˆ·ç«¯
- **PostgreSQL** - å…³ç³»å‹æ•°æ®åº“ï¼ˆé€šè¿‡ Supabaseï¼‰

### å·¥å…·åº“
- **zod 4.3.x** - æ•°æ®éªŒè¯å’Œç±»å‹æ¨æ–­
- **openai 6.6.x** - OpenAI API å®¢æˆ·ç«¯
- **dotenv 17.2.x** - ç¯å¢ƒå˜é‡ç®¡ç†
- **cors 2.8.x** - è·¨åŸŸèµ„æºå…±äº«

---

## ç›®å½•ç»“æ„

```
backend/src/
â”œâ”€â”€ index.js                    # åº”ç”¨å…¥å£æ–‡ä»¶
â”œâ”€â”€ supabase.js                 # Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–
â”‚
â”œâ”€â”€ config/                     # é…ç½®ç®¡ç†
â”‚   â””â”€â”€ index.js               # ç¯å¢ƒå˜é‡å’Œé…ç½®ç®¡ç†
â”‚
â”œâ”€â”€ controllers/                # æ§åˆ¶å™¨å±‚ï¼ˆHTTP è¯·æ±‚å¤„ç†ï¼‰
â”‚   â”œâ”€â”€ aiChatController.js    # AI èŠå¤©æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ imageController.js     # å›¾ç‰‡ç”Ÿæˆæ§åˆ¶å™¨
â”‚   â”œâ”€â”€ planController.js      # æ—…è¡Œè§„åˆ’æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ playlistController.js  # BGM æ­Œå•æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ postcardController.js  # æ˜ä¿¡ç‰‡æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ promptController.js    # æç¤ºè¯æ§åˆ¶å™¨
â”‚   â””â”€â”€ shareController.js     # åˆ†äº«æ–‡æ¡ˆæ§åˆ¶å™¨
â”‚
â”œâ”€â”€ routes/                     # è·¯ç”±å±‚ï¼ˆAPI ç«¯ç‚¹å®šä¹‰ï¼‰
â”‚   â”œâ”€â”€ index.js               # è·¯ç”±èšåˆ
â”‚   â”œâ”€â”€ aiChatRoutes.js        # AI èŠå¤©è·¯ç”±
â”‚   â”œâ”€â”€ imageRoutes.js         # å›¾ç‰‡ç”Ÿæˆè·¯ç”±
â”‚   â”œâ”€â”€ planRoutes.js          # æ—…è¡Œè§„åˆ’è·¯ç”±
â”‚   â”œâ”€â”€ playlistRoutes.js      # BGM æ­Œå•è·¯ç”±
â”‚   â”œâ”€â”€ postcardRoutes.js      # æ˜ä¿¡ç‰‡è·¯ç”±
â”‚   â”œâ”€â”€ promptRoutes.js         # æç¤ºè¯è·¯ç”±
â”‚   â””â”€â”€ shareRoutes.js         # åˆ†äº«æ–‡æ¡ˆè·¯ç”±
â”‚
â”œâ”€â”€ services/                   # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”œâ”€â”€ aiChatService.js       # AI èŠå¤©æœåŠ¡ï¼ˆæ ¸å¿ƒï¼‰
â”‚   â”œâ”€â”€ imageService.js        # å›¾ç‰‡ç”ŸæˆæœåŠ¡
â”‚   â”œâ”€â”€ mcpService.js          # MCP å·¥å…·æœåŠ¡
â”‚   â”œâ”€â”€ planService.js         # æ—…è¡Œè§„åˆ’æœåŠ¡
â”‚   â”œâ”€â”€ playlistService.js     # BGM æ­Œå•æœåŠ¡
â”‚   â”œâ”€â”€ postcardService.js     # æ˜ä¿¡ç‰‡æœåŠ¡
â”‚   â”œâ”€â”€ promptService.js       # æç¤ºè¯ä¼˜åŒ–æœåŠ¡
â”‚   â”œâ”€â”€ shareService.js        # åˆ†äº«æ–‡æ¡ˆæœåŠ¡
â”‚   â”œâ”€â”€ ttsService.js          # è¯­éŸ³åˆæˆæœåŠ¡
â”‚   â”‚
â”‚   â””â”€â”€ langchain/             # LangChain é›†æˆå±‚
â”‚       â”œâ”€â”€ LangChainManager.js  # LangChain ç®¡ç†å™¨ï¼ˆæ ¸å¿ƒï¼‰
â”‚       â”œâ”€â”€ base/              # åŸºç¡€é€‚é…å™¨
â”‚       â”‚   â”œâ”€â”€ BaseImageAdapter.js
â”‚       â”‚   â”œâ”€â”€ BaseLLMAdapter.js
â”‚       â”‚   â””â”€â”€ interfaces.js
â”‚       â”œâ”€â”€ image/             # å›¾ç‰‡ç”Ÿæˆé€‚é…å™¨
â”‚       â”‚   â””â”€â”€ ModelScopeImageAdapter.js
â”‚       â””â”€â”€ text/              # æ–‡æœ¬ç”Ÿæˆé€‚é…å™¨
â”‚           â””â”€â”€ OpenAICompatibleAdapter.js
â”‚
â”œâ”€â”€ middleware/                 # ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ errorHandler.js        # é”™è¯¯å¤„ç†ä¸­é—´ä»¶
â”‚   â””â”€â”€ logger.js              # è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
â”‚
â””â”€â”€ utils/                      # å·¥å…·å‡½æ•°
    â”œâ”€â”€ helpers.js             # é€šç”¨è¾…åŠ©å‡½æ•°
    â”œâ”€â”€ logger.js              # æ—¥å¿—å·¥å…·
    â””â”€â”€ sensitiveFilter.js    # æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
```

---

## æ ¸å¿ƒæ¶æ„è®¾è®¡

### åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Client (Frontend)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ HTTP/JSON
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Controller Layer (è·¯ç”±+æ§åˆ¶å™¨)               â”‚
â”‚  - æ¥æ”¶ HTTP è¯·æ±‚                                        â”‚
â”‚  - å‚æ•°éªŒè¯                                              â”‚
â”‚  - å“åº”æ ¼å¼åŒ–                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Service Layer (ä¸šåŠ¡é€»è¾‘å±‚)                   â”‚
â”‚  - AI èŠå¤©æœåŠ¡ (AIChatService)                           â”‚
â”‚  - æ—…è¡Œè§„åˆ’æœåŠ¡ (PlanService)                            â”‚
â”‚  - å›¾ç‰‡ç”ŸæˆæœåŠ¡ (ImageService)                           â”‚
â”‚  - MCP å·¥å…·æœåŠ¡ (MCPService)                             â”‚
â”‚  - å…¶ä»–ä¸“é¡¹æœåŠ¡                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          LangChain Integration Layer                     â”‚
â”‚  - LangChainManager (ç»Ÿä¸€ AI è°ƒç”¨)                       â”‚
â”‚  - Provider Adapters (æä¾›å•†é€‚é…)                        â”‚
â”‚  - Fallback & Retry (é™çº§ä¸é‡è¯•)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          External AI Services (å¤–éƒ¨ AI æœåŠ¡)             â”‚
â”‚  - OpenAI Compatible Providers                          â”‚
â”‚  - ModelScope Image Provider                            â”‚
â”‚  - MCP Servers (12306, Amap, Bing, etc.)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Data Layer (æ•°æ®å±‚)                             â”‚
â”‚  - Supabase (PostgreSQL)                                â”‚
â”‚  - Local File System (éŸ³é¢‘æ–‡ä»¶å­˜å‚¨)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Mermaid æ¶æ„å›¾

```mermaid
graph TB
    subgraph Client["å®¢æˆ·ç«¯å±‚"]
        FE[Frontend<br/>Vue.js åº”ç”¨]
    end

    subgraph Controller["æ§åˆ¶å±‚ (Controller Layer)"]
        APIRouter[API Routes<br/>è·¯ç”±èšåˆ]
        AIChatCtrl[AIChatController]
        PlanCtrl[PlanController]
        ImageCtrl[ImageController]
        OtherCtrl[Other Controllers<br/>Prompt/Playlist/...]
    end

    subgraph Service["æœåŠ¡å±‚ (Service Layer)"]
        AIChatSvc[AIChatService<br/>AI èŠå¤©ä¸å·¥å…·è°ƒç”¨]
        PlanSvc[PlanService<br/>æ—…è¡Œè§„åˆ’]
        ImageSvc[ImageService<br/>å›¾ç‰‡ç”Ÿæˆ]
        MCPSvc[MCPService<br/>MCP å·¥å…·ç®¡ç†]
        OtherSvc[Other Services<br/>TTS/Prompt/Playlist/...]
    end

    subgraph LangChain["LangChain é›†æˆå±‚"]
        LCMgr[LangChainManager<br/>ç»Ÿä¸€ AI è°ƒç”¨ç®¡ç†]
        TextAdapters[Text Adapters<br/>OpenAICompatible]
        ImageAdapters[Image Adapters<br/>ModelScope]
    end

    subgraph AIProviders["AI æä¾›å•†å±‚"]
        GitCode[GitCode<br/>Kimi-K2/Qwen]
        DashScope[DashScope<br/>Qwen Series]
        ModelScope[ModelScope<br/>Image Generation]
        OtherAI[Other AI Providers]
    end

    subgraph MCPTools["MCP å·¥å…·å±‚"]
        Tool12306[12306<br/>ç«è½¦ç¥¨æŸ¥è¯¢]
        ToolAmap[Amap<br/>é«˜å¾·åœ°å›¾]
        ToolBing[Bing<br/>ç½‘ç»œæœç´¢]
        OtherMCP[Other MCP Servers]
    end

    subgraph Data["æ•°æ®å±‚ (Data Layer)"]
        Supabase[Supabase<br/>PostgreSQL]
        LocalFS[Local File System<br/>éŸ³é¢‘/å›¾ç‰‡å­˜å‚¨]
    end

    FE -->|HTTP/JSON| APIRouter
    APIRouter --> AIChatCtrl
    APIRouter --> PlanCtrl
    APIRouter --> ImageCtrl
    APIRouter --> OtherCtrl

    AIChatCtrl --> AIChatSvc
    PlanCtrl --> PlanSvc
    ImageCtrl --> ImageSvc
    AIChatSvc --> MCPSvc
    OtherCtrl --> OtherSvc

    AIChatSvc --> LCMgr
    PlanSvc --> LCMgr
    ImageSvc --> LCMgr
    OtherSvc --> LCMgr

    LCMgr --> TextAdapters
    LCMgr --> ImageAdapters

    TextAdapters --> GitCode
    TextAdapters --> DashScope
    TextAdapters --> OtherAI

    ImageAdapters --> ModelScope

    MCPSvc --> Tool12306
    MCPSvc --> ToolAmap
    MCPSvc --> ToolBing
    MCPSvc --> OtherMCP

    AIChatSvc --> Supabase
    PlanSvc --> Supabase
    AIChatSvc --> LocalFS
    ImageSvc --> LocalFS

    style FE fill:#e1f5ff
    style APIRouter fill:#fff4e1
    style AIChatSvc fill:#e8f5e9
    style PlanSvc fill:#e8f5e9
    style ImageSvc fill:#e8f5e9
    style LCMgr fill:#f3e5f5
    style GitCode fill:#ffebee
    style DashScope fill:#ffebee
    style ModelScope fill:#ffebee
    style Tool12306 fill:#fff3e0
    style ToolAmap fill:#fff3e0
    style ToolBing fill:#fff3e0
    style Supabase fill:#e0f7fa
    style LocalFS fill:#e0f7fa
```

### è®¾è®¡åŸåˆ™

1. **å…³æ³¨ç‚¹åˆ†ç¦»**
   - Controller å±‚ï¼šå¤„ç† HTTP è¯·æ±‚/å“åº”
   - Service å±‚ï¼šå°è£…ä¸šåŠ¡é€»è¾‘
   - LangChain å±‚ï¼šç»Ÿä¸€ AI æœåŠ¡ç®¡ç†

2. **ä¾èµ–æ³¨å…¥**
   - Services é€šè¿‡æ„é€ å‡½æ•°æ¥æ”¶ä¾èµ–
   - ä¾¿äºå•å…ƒæµ‹è¯•å’Œæ¨¡å—æ›¿æ¢

3. **é”™è¯¯å¤„ç†ç»Ÿä¸€**
   - ä¸­é—´ä»¶ç»Ÿä¸€æ•è·å’Œå¤„ç†é”™è¯¯
   - æ ‡å‡†åŒ–é”™è¯¯å“åº”æ ¼å¼

4. **å¯æ‰©å±•æ€§**
   - Provider æ¨¡å¼æ”¯æŒæ–°å¢ AI æä¾›å•†
   - MCP åè®®æ”¯æŒå·¥å…·æ‰©å±•

---

## æ¨¡å—è¯¦è§£

### 1. åº”ç”¨å…¥å£ (index.js)

**èŒè´£ï¼š**
- Express åº”ç”¨åˆå§‹åŒ–
- ä¸­é—´ä»¶æ³¨å†Œ
- è·¯ç”±æ³¨å†Œ
- æœåŠ¡åˆå§‹åŒ–
- æœåŠ¡å™¨å¯åŠ¨

**å…³é”®æµç¨‹ï¼š**

```javascript
1. åˆ›å»º Express åº”ç”¨
2. æ³¨å†Œä¸­é—´ä»¶ (CORS, JSON Parser, Logger)
3. å¥åº·æ£€æŸ¥ç«¯ç‚¹ (/health)
4. å‰ç«¯é…ç½®æ³¨å…¥ç«¯ç‚¹ (/config.js)
5. åˆå§‹åŒ–æœåŠ¡
   - LangChainManager
   - MCPService
   - PlanService
   - AIChatService
   - ImageService
   - ç­‰ç­‰...
6. åˆå§‹åŒ–æ§åˆ¶å™¨
7. æ³¨å†Œè·¯ç”±
8. å¯åŠ¨æœåŠ¡å™¨
```

**ç‰¹æ®Šç«¯ç‚¹ï¼š**

#### `/health`
```json
{
  "status": "ok",
  "timestamp": "2025-01-20T10:00:00.000Z",
  "providers": {
    "text": 2,
    "image": 1
  }
}
```

#### `/config.js`
è¿”å›å‰ç«¯è¿è¡Œæ—¶é…ç½®ï¼ˆJavaScript æ–‡ä»¶æ ¼å¼ï¼‰ï¼š
```javascript
window.__APP_CONFIG__ = {
  "supabaseUrl": "https://xxx.supabase.co",
  "supabaseAnonKey": "eyJxxx...",
  "amapKey": "xxx...",
  "amapSecurityCode": "xxx...",
  "amapRestKey": "yyy..."
};
```

---

### 2. é…ç½®ç®¡ç† (config/index.js)

**èŒè´£ï¼š**
- é›†ä¸­ç®¡ç†ç¯å¢ƒå˜é‡
- æä¾› AI æä¾›å•†é…ç½®
- URL æ¸…ç†å’Œè§„èŒƒåŒ–
- ä¼˜å…ˆçº§è§£æ

**æ ¸å¿ƒé…ç½®ï¼š**

#### æœåŠ¡å™¨é…ç½®
```javascript
server: {
  port: 3001,
  host: '0.0.0.0'
}
```

#### AI æ–‡æœ¬æä¾›å•†é…ç½®
é€šè¿‡ç¯å¢ƒå˜é‡ `AI_TEXT_PROVIDERS_JSON` é…ç½®ï¼š

```json
[
  {
    "name": "gitcode",
    "enabled": true,
    "baseURL": "https://api.gitcode.com/api/v5",
    "apiKey": "sk-xxx",
    "model": "Kimi-K2",
    "priority": 1,
    "models": [
      { "model": "Kimi-K2", "priority": 1 },
      { "model": "qwen-max", "priority": 2 }
    ]
  },
  {
    "name": "dashscope",
    "enabled": true,
    "baseURL": "https://dashscope.aliyuncs.com/compatible-mode/v1",
    "apiKey": "sk-xxx",
    "model": "qwen-max",
    "priority": 2
  }
]
```

#### AI å›¾ç‰‡æä¾›å•†é…ç½®
é€šè¿‡ç¯å¢ƒå˜é‡ `AI_IMAGE_PROVIDERS_JSON` é…ç½®ï¼š

```json
[
  {
    "name": "modelscope",
    "enabled": true,
    "apiKey": "xxx",
    "priority": 1
  }
]
```

---

### 3. æ§åˆ¶å™¨å±‚ (Controllers)

æ‰€æœ‰æ§åˆ¶å™¨éµå¾ªç»Ÿä¸€æ¨¡å¼ï¼š
- æ¥æ”¶ HTTP è¯·æ±‚
- å‚æ•°éªŒè¯
- è°ƒç”¨å¯¹åº”çš„ Service
- æ ¼å¼åŒ–å“åº”
- é”™è¯¯å¤„ç†

#### 3.1 AIChatController

**è·¯ç”±ï¼š**
- `POST /api/ai-chat/session` - åˆ›å»ºèŠå¤©ä¼šè¯
- `POST /api/ai-chat/message` - å‘é€æ¶ˆæ¯
- `POST /api/ai-chat/stop` - åœæ­¢ç”Ÿæˆ
- `GET /api/ai-chat/audio/:sessionId` - è·å–éŸ³é¢‘åˆ—è¡¨
- `DELETE /api/ai-chat/session/:sessionId` - åˆ é™¤ä¼šè¯

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- AI èŠå¤©å¯¹è¯
- MCP å·¥å…·è°ƒç”¨
- è¯­éŸ³åˆæˆ
- ä¼šè¯ç®¡ç†

#### 3.2 PlanController

**è·¯ç”±ï¼š**
- `POST /api/plan/generate` - ç”Ÿæˆæ—…è¡Œè®¡åˆ’

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- åŸºäºç”¨æˆ·éœ€æ±‚ç”Ÿæˆæ—…è¡Œæ–¹æ¡ˆ
- é¢„ç®—åˆ†è§£å’Œä¼˜åŒ–
- å¤šæä¾›å•† AI è°ƒç”¨

#### 3.3 ImageController

**è·¯ç”±ï¼š**
- `POST /api/image/generate` - ç”Ÿæˆå›¾ç‰‡
- `GET /api/image/:id` - è·å–å›¾ç‰‡

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
- AI å›¾ç‰‡ç”Ÿæˆ
- å›¾ç‰‡å­˜å‚¨ç®¡ç†
- ModelScope é›†æˆ

#### 3.4 å…¶ä»–æ§åˆ¶å™¨

- **PromptController** - æç¤ºè¯ä¼˜åŒ–
- **PlaylistController** - BGM æ­Œå•ç”Ÿæˆ
- **PostcardController** - æ—…æ¸¸æ˜ä¿¡ç‰‡ç”Ÿæˆ
- **ShareController** - åˆ†äº«æ–‡æ¡ˆç”Ÿæˆ

---

### 4. æœåŠ¡å±‚ (Services)

#### 4.1 LangChainManager (æ ¸å¿ƒ)

**èŒè´£ï¼š**
- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ AI è°ƒç”¨
- æä¾›å•†é€‰æ‹©å’Œé™çº§
- é”™è¯¯å¤„ç†å’Œé‡è¯•
- è¯·æ±‚è¿½è¸ªå’Œè°ƒè¯•

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```javascript
// æ–‡æœ¬ç”Ÿæˆ
async invokeText(messages, options = {
  provider,          // æŒ‡å®šæä¾›å•†
  allowedProviders,  // å…è®¸çš„æä¾›å•†åˆ—è¡¨
  temperature,
  maxTokens,
  onAdapterStart,    // é€‚é…å™¨å›è°ƒ
  trace             // è¿½è¸ªä¿¡æ¯
})

// å›¾ç‰‡ç”Ÿæˆ
async invokeImage(prompt, options = {
  provider,
  width,
  height,
  steps
})

// ç»“æ„åŒ–è¾“å‡º
async invokeStructured(messages, schema, options)
```

**é™çº§ç­–ç•¥ï¼š**
1. æŒ‰ä¼˜å…ˆçº§å°è¯•æä¾›å•†
2. å¤±è´¥è‡ªåŠ¨åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ª
3. å…¨éƒ¨å¤±è´¥æŠ›å‡ºé”™è¯¯

**è¿½è¸ªæœºåˆ¶ï¼š**
- ä½¿ç”¨ AsyncLocalStorage è¿½è¸ªè¯·æ±‚
- æ”¯æŒè°ƒè¯•æ—¥å¿—ï¼ˆAI_CHAT_DEBUG=1ï¼‰
- è®°å½•æ¯ä¸ªè°ƒç”¨ä½¿ç”¨çš„æä¾›å•†

#### 4.2 AIChatService

**èŒè´£ï¼š**
- AI èŠå¤©ä¼šè¯ç®¡ç†
- MCP å·¥å…·è°ƒç”¨
- è¯­éŸ³åˆæˆé›†æˆ
- é€Ÿç‡é™åˆ¶å’Œé”™è¯¯å¤„ç†

**æ ¸å¿ƒåŠŸèƒ½ï¼š**

**1. ä¼šè¯ç®¡ç†**
```javascript
// åˆ›å»ºä¼šè¯
async createSession(userId, options)

// å‘é€æ¶ˆæ¯
async sendMessage(sessionId, message, options)

// åœæ­¢ç”Ÿæˆ
async stopGeneration(sessionId)
```

**2. MCP å·¥å…·é›†æˆ**
```javascript
// è°ƒç”¨ MCP å·¥å…·
async invokeMcpTool(toolName, toolInput, options)

// è·å–å¯ç”¨å·¥å…·åˆ—è¡¨
getAvailableTools()
```

**3. è¯­éŸ³åˆæˆ**
```javascript
// ç”Ÿæˆè¯­éŸ³
async synthesizeSpeech(text, options)

// è·å–éŸ³é¢‘æ–‡ä»¶
getAudioFiles(sessionId)
```

**é€Ÿç‡é™åˆ¶ï¼š**
- å·¥å…·è°ƒç”¨é¢‘ç‡é™åˆ¶
- æ¨¡å‹å†·å´æ—¶é—´
- è¯·æ±‚å»é‡

#### 4.3 PlanService

**èŒè´£ï¼š**
- æ—…è¡Œè§„åˆ’ä¸šåŠ¡é€»è¾‘
- é¢„ç®—è®¡ç®—å’Œåˆ†è§£
- MCP å·¥å…·é›†æˆï¼ˆæŸ¥è¯¢ä¿¡æ¯ï¼‰

**æ ¸å¿ƒæ–¹æ³•ï¼š**

```javascript
// ç”Ÿæˆæ—…è¡Œè®¡åˆ’
async generatePlan(input, options)

// é¢„ç®—è§£æ
parseMoneyToNumber(raw)

// é¢„ç®—åˆ†è§£è§„èŒƒåŒ–
normalizeBudgetBreakdown(input)
```

**å·¥ä½œæµç¨‹ï¼š**
1. è§£æç”¨æˆ·è¾“å…¥
2. è°ƒç”¨ MCP å·¥å…·æŸ¥è¯¢ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
3. è°ƒç”¨ AI ç”Ÿæˆè®¡åˆ’
4. éªŒè¯å’Œè§„èŒƒåŒ–ç»“æœ
5. è¿”å›ç»“æ„åŒ–è®¡åˆ’

#### 4.4 MCPService

**èŒè´£ï¼š**
- MCP æœåŠ¡å™¨ç®¡ç†
- å·¥å…·è°ƒç”¨
- è¿æ¥æ± å’Œè¶…æ—¶å¤„ç†

**æ”¯æŒçš„ MCP æœåŠ¡å™¨ï¼š**
- **12306** - ç«è½¦ç¥¨æŸ¥è¯¢
- **Amap** - é«˜å¾·åœ°å›¾æœåŠ¡
- **Bing** - Bing æœç´¢
- è‡ªå®šä¹‰æœåŠ¡å™¨ï¼ˆé€šè¿‡ MCP_SERVERS_JSON é…ç½®ï¼‰

**é…ç½®ç¤ºä¾‹ï¼š**
```bash
MCP_12306_URL=https://mcp.api-inference.modelscope.net/xxx/sse
MCP_12306_AUTHORIZATION=Bearer xxx

MCP_AMAP_URL=xxx
MCP_AMAP_AUTHORIZATION=Bearer xxx

MCP_BING_URL=xxx
MCP_BING_AUTHORIZATION=Bearer xxx

MCP_SERVERS_JSON='{
  "custom-server": {
    "url": "https://...",
    "transport": "sse",
    "headers": {
      "Authorization": "Bearer xxx"
    }
  }
}'
```

#### 4.5 å…¶ä»–æœåŠ¡

**ImageService**
- å›¾ç‰‡ç”Ÿæˆä¸šåŠ¡é€»è¾‘
- ä¸ LangChainManager é›†æˆ
- å›¾ç‰‡å­˜å‚¨ç®¡ç†

**TtsService**
- è¯­éŸ³åˆæˆæœåŠ¡
- æ”¯æŒæœ¬åœ° Windows TTS
- éŸ³é¢‘æ–‡ä»¶ç®¡ç†

**PromptService**
- æç¤ºè¯ä¼˜åŒ–
- è‰ºæœ¯é£æ ¼è½¬æ¢
- å¤šå¹³å°é€‚é…

**PlaylistService**
- BGM æ­Œå•ç”Ÿæˆ
- éŸ³ä¹é£æ ¼åŒ¹é…

**PostcardService**
- æ˜ä¿¡ç‰‡ç”Ÿæˆ
- æ¨¡æ¿åº”ç”¨

**ShareService**
- åˆ†äº«æ–‡æ¡ˆç”Ÿæˆ
- å¹³å°é€‚é…

---

### 5. LangChain é›†æˆå±‚

#### 5.1 LangChainManager

**æ¶æ„ï¼š**

```
LangChainManager
â”œâ”€â”€ Text Adapters[]       (æ–‡æœ¬ç”Ÿæˆé€‚é…å™¨)
â”‚   â””â”€â”€ OpenAICompatibleAdapter
â”‚       â”œâ”€â”€ GitCode (Kimi-K2)
â”‚       â”œâ”€â”€ DashScope (Qwen)
â”‚       â””â”€â”€ ... (å…¶ä»– OpenAI å…¼å®¹æä¾›å•†)
â”‚
â””â”€â”€ Image Adapters[]     (å›¾ç‰‡ç”Ÿæˆé€‚é…å™¨)
    â””â”€â”€ ModelScopeImageAdapter
```

**åˆå§‹åŒ–ï¼š**
```javascript
const langChainManager = new LangChainManager(
  textProviders,    // æ–‡æœ¬æä¾›å•†é…ç½®
  imageProviders    // å›¾ç‰‡æä¾›å•†é…ç½®
);
```

**æ ¸å¿ƒåŠŸèƒ½ï¼š**
1. **æä¾›å•†ç®¡ç†**
   - åŠ¨æ€åˆå§‹åŒ–é€‚é…å™¨
   - ä¼˜å…ˆçº§æ’åº
   - å¯ç”¨æ€§æ£€æŸ¥

2. **è°ƒç”¨é™çº§**
   - è‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªæä¾›å•†
   - è®°å½•å¤±è´¥åŸå› 
   - å®Œæ•´çš„é”™è¯¯è¿½è¸ª

3. **å…ƒæ•°æ®è¿½è¸ª**
   - è®°å½•æ¯ä¸ªè°ƒç”¨ä½¿ç”¨çš„æä¾›å•†
   - è¿½è¸ªè¯·æ±‚é“¾è·¯
   - æ”¯æŒè°ƒè¯•æ¨¡å¼

#### 5.2 åŸºç¡€é€‚é…å™¨

**BaseLLMAdapter**
```javascript
class BaseLLMAdapter {
  constructor(provider)
  isAvailable()
  invoke(messages, options)
  getName()
  getModel()
}
```

**BaseImageAdapter**
```javascript
class BaseImageAdapter {
  constructor(provider)
  isAvailable()
  generate(prompt, options)
  getName()
}
```

#### 5.3 å…·ä½“é€‚é…å™¨

**OpenAICompatibleAdapter**
- æ”¯æŒæ‰€æœ‰ OpenAI å…¼å®¹ API
- ç”¨äº GitCodeã€DashScopeã€OpenAI ç­‰

**ModelScopeImageAdapter**
- é­”æ­ç¤¾åŒºå›¾ç‰‡ç”Ÿæˆ
- æ”¯æŒå¤šç§æ¨¡å‹

---

### 6. ä¸­é—´ä»¶

#### 6.1 Logger Middleware

**èŒè´£ï¼š**
- è®°å½•æ‰€æœ‰ HTTP è¯·æ±‚
- è®°å½•å“åº”æ—¶é—´
- è®°å½•è¯·æ±‚/å“åº”ä½“ï¼ˆå¯é€‰ï¼‰

**æ—¥å¿—æ ¼å¼ï¼š**
```javascript
[2025-01-20T10:00:00.000Z] POST /api/ai-chat/message {
  method: 'POST',
  url: '/api/ai-chat/message',
  ip: '127.0.0.1',
  userAgent: 'Mozilla/5.0...',
  duration: 1234,
  status: 200
}
```

#### 6.2 Error Handler Middleware

**èŒè´£ï¼š**
- æ•è·æ‰€æœ‰é”™è¯¯
- æ ‡å‡†åŒ–é”™è¯¯å“åº”
- è®°å½•é”™è¯¯æ—¥å¿—

**é”™è¯¯å“åº”æ ¼å¼ï¼š**
```json
{
  "error": {
    "code": "MODEL_INVOKE_FAILED",
    "message": "æ¨¡å‹è°ƒç”¨å¤±è´¥",
    "details": "...",
    "timestamp": "2025-01-20T10:00:00.000Z"
  }
}
```

---

## AI æœåŠ¡é›†æˆ

### æ–‡æœ¬ç”Ÿæˆæä¾›å•†

#### 1. GitCode (Kimi-K2)
```bash
AI_TEXT_PROVIDERS_JSON='[{
  "name": "gitcode",
  "enabled": true,
  "baseURL": "https://api.gitcode.com/api/v5",
  "apiKey": "sk-xxx",
  "model": "Kimi-K2",
  "priority": 1
}]'
```

#### 2. é˜¿é‡Œäº‘ DashScope (Qwen)
```bash
AI_TEXT_PROVIDERS_JSON='[{
  "name": "dashscope",
  "enabled": true,
  "baseURL": "https://dashscope.aliyuncs.com/compatible-mode/v1",
  "apiKey": "sk-xxx",
  "model": "qwen-max",
  "priority": 2
}]'
```

#### 3. OpenAI
```bash
AI_TEXT_PROVIDERS_JSON='[{
  "name": "openai",
  "enabled": true,
  "baseURL": "https://api.openai.com/v1",
  "apiKey": "sk-xxx",
  "model": "gpt-4",
  "priority": 3
}]'
```

### å›¾ç‰‡ç”Ÿæˆæä¾›å•†

#### ModelScope
```bash
AI_IMAGE_PROVIDERS_JSON='[{
  "name": "modelscope",
  "enabled": true,
  "apiKey": "xxx",
  "priority": 1
}]'
```

### è°ƒç”¨ç­–ç•¥

**æ–‡æœ¬ç”Ÿæˆï¼š**
1. æŒ‰ä¼˜å…ˆçº§é€‰æ‹©æä¾›å•†
2. å¤±è´¥è‡ªåŠ¨é™çº§
3. æ”¯æŒæŒ‡å®šæä¾›å•†
4. æ”¯æŒé™åˆ¶å…è®¸çš„æä¾›å•†

**å›¾ç‰‡ç”Ÿæˆï¼š**
1. æŒ‰ä¼˜å…ˆçº§é€‰æ‹©æä¾›å•†
2. å¤±è´¥è‡ªåŠ¨é™çº§
3. æ”¯æŒè‡ªå®šä¹‰å°ºå¯¸å’Œæ­¥æ•°

---

## MCP å·¥å…·é›†æˆ

### MCP åè®®

MCP (Model Context Protocol) æ˜¯ä¸€ä¸ªå¼€æ”¾åè®®ï¼Œç”¨äº AI æ¨¡å‹ä¸å¤–éƒ¨å·¥å…·çš„é€šä¿¡ã€‚

### æ”¯æŒçš„å·¥å…·

#### 1. 12306 ç«è½¦ç¥¨æŸ¥è¯¢
- è½¦æ¬¡æŸ¥è¯¢
- ä½™ç¥¨æŸ¥è¯¢
- ç¥¨ä»·æŸ¥è¯¢

#### 2. é«˜å¾·åœ°å›¾
- POI æœç´¢
- è·¯å¾„è§„åˆ’
- åœ°ç†ç¼–ç 

#### 3. Bing æœç´¢
- ç½‘é¡µæœç´¢
- èµ„è®¯æŸ¥è¯¢
- å®æ—¶ä¿¡æ¯

### å·¥å…·è°ƒç”¨æµç¨‹

```
AI è¯·æ±‚å·¥å…·è°ƒç”¨
    â†“
MCPService è·¯ç”±åˆ°å¯¹åº”æœåŠ¡å™¨
    â†“
MCP Server æ‰§è¡Œå·¥å…·
    â†“
è¿”å›ç»“æœç»™ AI
    â†“
AI åŸºäºç»“æœç”Ÿæˆå›å¤
```

### å·¥å…·é…ç½®

```bash
# 12306
MCP_12306_URL=https://mcp.api-inference.modelscope.net/xxx/sse
MCP_12306_AUTHORIZATION=Bearer xxx

# é«˜å¾·åœ°å›¾
MCP_AMAP_URL=xxx
MCP_AMAP_AUTHORIZATION=Bearer xxx

# Bing
MCP_BING_URL=xxx
MCP_BING_AUTHORIZATION=Bearer xxx

# è‡ªå®šä¹‰æœåŠ¡å™¨
MCP_SERVERS_JSON='{
  "my-server": {
    "url": "https://...",
    "transport": "sse",
    "headers": {
      "Authorization": "Bearer xxx"
    }
  }
}'
```

---

## API è·¯ç”±è®¾è®¡

### RESTful API è®¾è®¡åŸåˆ™

1. **ç»Ÿä¸€å‰ç¼€**ï¼š`/api`
2. **èµ„æºå¯¼å‘**ï¼šä½¿ç”¨åè¯è€ŒéåŠ¨è¯
3. **HTTP æ–¹æ³•**ï¼š
   - GET - è·å–èµ„æº
   - POST - åˆ›å»ºèµ„æº
   - PUT - æ›´æ–°èµ„æº
   - DELETE - åˆ é™¤èµ„æº

### ä¸»è¦è·¯ç”±

#### AI èŠå¤©
```
POST   /api/ai-chat/session          # åˆ›å»ºä¼šè¯
POST   /api/ai-chat/message           # å‘é€æ¶ˆæ¯
POST   /api/ai-chat/stop              # åœæ­¢ç”Ÿæˆ
GET    /api/ai-chat/audio/:sessionId  # è·å–éŸ³é¢‘
DELETE /api/ai-chat/session/:id       # åˆ é™¤ä¼šè¯
```

#### æ—…è¡Œè§„åˆ’
```
POST   /api/plan/generate             # ç”Ÿæˆè®¡åˆ’
```

#### å›¾ç‰‡ç”Ÿæˆ
```
POST   /api/image/generate            # ç”Ÿæˆå›¾ç‰‡
GET    /api/image/:id                 # è·å–å›¾ç‰‡
```

#### æç¤ºè¯ä¼˜åŒ–
```
POST   /api/prompt/optimize           # ä¼˜åŒ–æç¤ºè¯
```

#### BGM æ­Œå•
```
POST   /api/playlist/generate         # ç”Ÿæˆæ­Œå•
```

#### æ˜ä¿¡ç‰‡
```
POST   /api/postcard/generate         # ç”Ÿæˆæ˜ä¿¡ç‰‡
```

#### åˆ†äº«æ–‡æ¡ˆ
```
POST   /api/share/generate            # ç”Ÿæˆæ–‡æ¡ˆ
```

---

## é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡

#### å¿…éœ€é…ç½®
```bash
# æœåŠ¡å™¨
PORT=3001
HOST=0.0.0.0

# AI æ–‡æœ¬æä¾›å•†ï¼ˆJSON æ ¼å¼ï¼‰
AI_TEXT_PROVIDERS_JSON='[...]'

# Supabase
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...

# å‰ç«¯å…¬å¼€é…ç½®
PUBLIC_SUPABASE_URL=https://xxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJxxx...
```

#### å¯é€‰é…ç½®
```bash
# AI å›¾ç‰‡æä¾›å•†
AI_IMAGE_PROVIDERS_JSON='[...]'

# MCP å·¥å…·
MCP_12306_URL=...
MCP_12306_AUTHORIZATION=...
MCP_AMAP_URL=...
MCP_AMAP_AUTHORIZATION=...
MCP_BING_URL=...
MCP_BING_AUTHORIZATION=...

# é«˜å¾·åœ°å›¾
PUBLIC_AMAP_KEY=xxx
PUBLIC_AMAP_SECURITY_CODE=xxx
PUBLIC_AMAP_REST_KEY=yyy

# è°ƒè¯•
AI_CHAT_DEBUG=1
```

### é…ç½®åŠ è½½

1. åŠ è½½ `.env` æ–‡ä»¶ï¼ˆdotenvï¼‰
2. è§£æ JSON é…ç½®
3. éªŒè¯å’Œè§„èŒƒåŒ–
4. æŒ‰ä¼˜å…ˆçº§æ’åº

---

## é”™è¯¯å¤„ç†

### é”™è¯¯ç±»å‹

#### 1. ä¸šåŠ¡é”™è¯¯
```javascript
{
  "code": "MODEL_INVOKE_FAILED",
  "message": "æ¨¡å‹è°ƒç”¨å¤±è´¥",
  "details": "..."
}
```

#### 2. éªŒè¯é”™è¯¯
```javascript
{
  "code": "VALIDATION_ERROR",
  "message": "å‚æ•°éªŒè¯å¤±è´¥",
  "details": {
    "field": "destination",
    "message": "ç›®çš„åœ°ä¸èƒ½ä¸ºç©º"
  }
}
```

#### 3. é€Ÿç‡é™åˆ¶
```javascript
{
  "code": "TOOL_RATE_LIMIT",
  "message": "å·¥å…·è°ƒç”¨è¿‡äºé¢‘ç¹",
  "details": "è¯·ç¨åå†è¯•"
}
```

### é”™è¯¯å¤„ç†æµç¨‹

```
ä¸šåŠ¡é€»è¾‘æŠ›å‡ºé”™è¯¯
    â†“
Error Handler Middleware æ•è·
    â†“
é”™è¯¯åˆ†ç±»å’Œæ ¼å¼åŒ–
    â†“
è®°å½•é”™è¯¯æ—¥å¿—
    â†“
è¿”å›æ ‡å‡†é”™è¯¯å“åº”
```

### é”™è¯¯ç åˆ—è¡¨

| é”™è¯¯ç  | è¯´æ˜ |
|--------|------|
| MODEL_INVOKE_TIMEOUT | æ¨¡å‹è°ƒç”¨è¶…æ—¶ |
| TOOL_INVOKE_TIMEOUT | å·¥å…·è°ƒç”¨è¶…æ—¶ |
| PLAN_TIMEOUT | è§„åˆ’ç”Ÿæˆè¶…æ—¶ |
| MODEL_EMPTY_RESPONSE | æ¨¡å‹è¿”å›ç©ºç»“æœ |
| MODEL_INVOKE_FAILED | æ¨¡å‹è°ƒç”¨å¤±è´¥ |
| MODELSCOPE_REQUEST_LIMIT | ModelScope è¯·æ±‚æ¬¡æ•°å·²è¾¾ä¸Šé™ |
| MCP_STARTUP_TIMEOUT | MCP å¯åŠ¨è¶…æ—¶ |
| MCP_TIMEOUT | MCP è°ƒç”¨è¶…æ—¶ |
| MCP_CALL_TIMEOUT | MCP å·¥å…·è°ƒç”¨è¶…æ—¶ |
| TEXT_PROVIDER_UNAVAILABLE | æœªé…ç½®å¯ç”¨çš„æ–‡æœ¬æ¨¡å‹æä¾›å•† |
| IMAGE_PROVIDER_UNAVAILABLE | æœªé…ç½®å¯ç”¨çš„å›¾ç‰‡ç”Ÿæˆæä¾›å•† |
| TEXT_PROVIDER_NOT_FOUND | æœªæ‰¾åˆ°å¯ç”¨çš„æ–‡æœ¬æ¨¡å‹æä¾›å•† |
| TEXT_PROVIDER_ALL_FAILED | æ–‡æœ¬æ¨¡å‹è°ƒç”¨å¤±è´¥ |
| IMAGE_PROVIDER_ALL_FAILED | å›¾ç‰‡ç”Ÿæˆå¤±è´¥ |
| TOOL_RATE_LIMIT | å·¥å…·è°ƒç”¨è¿‡äºé¢‘ç¹ |
| TOOL_CALLS_EXCEEDED | å·¥å…·è°ƒç”¨æ¬¡æ•°è¿‡å¤š |
| PROVIDER_PROTOCOL_ERROR | AI æä¾›å•†åè®®é”™è¯¯ |
| RATE_LIMIT_EXCEEDED | è¯·æ±‚é¢‘ç‡å·²è¾¾ä¸Šé™ |
| TOOL_SCHEMA_ERROR | å·¥å…·å‚æ•°æ ¼å¼é”™è¯¯ |
| SESSION_NOT_FOUND | ä¼šè¯ä¸å­˜åœ¨ |
| TTS_SERVICE_UNAVAILABLE | è¯­éŸ³åˆæˆæœåŠ¡ä¸å¯ç”¨ |
| IMAGE_GENERATION_FAILED | å›¾ç‰‡ç”Ÿæˆå¤±è´¥ |

---

## æ€§èƒ½ä¼˜åŒ–

### 1. è¿æ¥æ± ç®¡ç†
- Supabase è¿æ¥å¤ç”¨
- MCP æœåŠ¡å™¨è¿æ¥æ± 

### 2. è¯·æ±‚ç¼“å­˜
- æä¾›å•†æ¢æµ‹ç¼“å­˜
- æ¨¡å‹èƒ½åŠ›ç¼“å­˜

### 3. å¹¶å‘æ§åˆ¶
- å¼‚æ­¥éé˜»å¡ I/O
- æµå¼å“åº”

### 4. é€Ÿç‡é™åˆ¶
- å·¥å…·è°ƒç”¨é¢‘ç‡é™åˆ¶
- æ¨¡å‹å†·å´æ—¶é—´

### 5. é”™è¯¯é‡è¯•
- è‡ªåŠ¨é™çº§åˆ°ä¸‹ä¸€ä¸ªæä¾›å•†
- æŒ‡æ•°é€€é¿é‡è¯•

---

## éƒ¨ç½²æŒ‡å—

### æœ¬åœ°å¼€å‘

```bash
# å®‰è£…ä¾èµ–
cd backend
npm install

# é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev
```

### ç”Ÿäº§éƒ¨ç½²

#### Docker éƒ¨ç½²

```bash
# æ„å»ºé•œåƒ
docker build -t ai-travel-planner-backend .

# è¿è¡Œå®¹å™¨
docker run -d \
  --name ai-travel-backend \
  -p 3001:3001 \
  --env-file .env \
  ai-travel-planner-backend
```

#### Docker Compose

```yaml
version: '3.8'
services:
  backend:
    build: ./backend
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
    env_file:
      - backend/.env
    restart: unless-stopped
```

### ç¯å¢ƒè¦æ±‚

- Node.js >= 18.0.0
- npm >= 9.0.0
- PostgreSQL (é€šè¿‡ Supabase)

### ç›‘æ§å’Œæ—¥å¿—

1. **å¥åº·æ£€æŸ¥**
   ```bash
   curl http://localhost:3001/health
   ```

2. **æ—¥å¿—æŸ¥çœ‹**
   - åº”ç”¨æ—¥å¿—ï¼šæ§åˆ¶å°è¾“å‡º
   - è¯·æ±‚æ—¥å¿—ï¼šlogger ä¸­é—´ä»¶
   - é”™è¯¯æ—¥å¿—ï¼šerrorHandler ä¸­é—´ä»¶

3. **è°ƒè¯•æ¨¡å¼**
   ```bash
   AI_CHAT_DEBUG=1 npm start
   ```

---

## å®‰å…¨è€ƒè™‘

### 1. API å¯†é’¥ä¿æŠ¤
- æ‰€æœ‰å¯†é’¥é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®
- ä¸åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
- `.env` æ–‡ä»¶ä¸æäº¤åˆ° Git

### 2. CORS é…ç½®
```javascript
cors: {
  origin: process.env.CORS_ORIGIN || '*',
  credentials: true
}
```

### 3. è¯·æ±‚å¤§å°é™åˆ¶
```javascript
app.use(express.json({ limit: '10mb' }));
```

### 4. æ•æ„Ÿä¿¡æ¯è¿‡æ»¤
- è‡ªåŠ¨è¿‡æ»¤ API å¯†é’¥
- è„±æ•å¤„ç†æ—¥å¿—

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°çš„ AI æä¾›å•†

1. **åˆ›å»ºé€‚é…å™¨**
   ```javascript
   // services/langchain/text/CustomAdapter.js
   const BaseLLMAdapter = require('../base/BaseLLMAdapter');

   class CustomAdapter extends BaseLLMAdapter {
     constructor(provider) {
       super(provider);
     }

     async invoke(messages, options) {
       // å®ç°è°ƒç”¨é€»è¾‘
     }
   }
   ```

2. **åœ¨ LangChainManager ä¸­æ³¨å†Œ**
   ```javascript
   const CustomAdapter = require('./text/CustomAdapter');

   this.textAdapters = textProviders.map(provider => {
     if (provider.name === 'custom') {
       return new CustomAdapter(provider);
     }
     // ...
   });
   ```

3. **é…ç½®ç¯å¢ƒå˜é‡**
   ```bash
   AI_TEXT_PROVIDERS_JSON='[{
     "name": "custom",
     "enabled": true,
     "baseURL": "...",
     "apiKey": "...",
     "model": "...",
     "priority": 1
   }]'
   ```

### æ·»åŠ æ–°çš„ MCP å·¥å…·

1. **é…ç½® MCP æœåŠ¡å™¨**
   ```bash
   MCP_CUSTOM_URL=https://...
   MCP_CUSTOM_AUTHORIZATION=Bearer xxx
   ```

2. **åœ¨ MCPService ä¸­å¤„ç†**
   ```javascript
   const customUrl = process.env.MCP_CUSTOM_URL;
   // ...
   ```

---

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åˆ‡æ¢ AI æä¾›å•†ï¼Ÿ
A: ä¿®æ”¹ `AI_TEXT_PROVIDERS_JSON` ç¯å¢ƒå˜é‡ï¼Œè°ƒæ•´ `priority` å­—æ®µã€‚

### Q: MCP å·¥å…·è°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ
A: æ£€æŸ¥ MCP æœåŠ¡å™¨ URL å’Œæˆæƒä¿¡æ¯ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨çŠ¶æ€ã€‚

### Q: å¦‚ä½•å¯ç”¨è°ƒè¯•æ—¥å¿—ï¼Ÿ
A: è®¾ç½® `AI_CHAT_DEBUG=1` ç¯å¢ƒå˜é‡ã€‚

### Q: å¦‚ä½•å¢åŠ è¯·æ±‚å¤§å°é™åˆ¶ï¼Ÿ
A: ä¿®æ”¹ `index.js` ä¸­çš„ `express.json({ limit: '10mb' })`ã€‚

### Q: å¦‚ä½•æ·»åŠ æ–°çš„è·¯ç”±ï¼Ÿ
A: åœ¨ `routes/` ç›®å½•åˆ›å»ºæ–°è·¯ç”±æ–‡ä»¶ï¼Œåœ¨ `routes/index.js` ä¸­æ³¨å†Œã€‚

---

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-01-20)
- åˆå§‹ç‰ˆæœ¬
- åŸºäº LangChain çš„ç»Ÿä¸€ AI æœåŠ¡ç®¡ç†
- MCP å·¥å…·é›†æˆ
- å®Œæ•´çš„ RESTful API

---

## è”ç³»æ–¹å¼

- é¡¹ç›®ä»“åº“ï¼š[GitHub]
- é—®é¢˜åé¦ˆï¼š[Issues]
- æ–‡æ¡£ï¼š[docs/](./)

---

**æœ€åæ›´æ–°ï¼š2025-01-20**
