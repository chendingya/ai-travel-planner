# 高德地图 API 配置指南

## 📍 为什么使用高德地图?

相比 Leaflet + OpenStreetMap,高德地图有以下优势:
- ✅ **路线规划**: 内置驾车、步行、公交等多种路线规划功能
- ✅ **中国地图优化**: 对中国境内地图数据更准确、更详细
- ✅ **实时路况**: 可显示实时交通状况
- ✅ **POI 搜索**: 丰富的兴趣点数据
- ✅ **官方支持**: 完善的中文文档和技术支持

## 🔑 如何获取高德地图 API Key

### 步骤 1: 注册账号
访问 [高德开放平台](https://console.amap.com/) 并注册账号

### 步骤 2: 创建应用
1. 登录控制台后,进入"应用管理" → "我的应用"
2. 点击"创建新应用"
3. 填写应用名称,如 "AI旅行规划系统"
4. 提交创建

### 步骤 3: 添加 Key
在同一个应用下分别新增两种 Key：

1. **Web端(JS API)**：供前端加载地图 SDK 使用
  - Key 名称可填写 "旅行规划前端"
2. **Web服务**：供服务器或前端通过 REST 接口进行 POI/地理编码调用
  - Key 名称可填写 "旅行规划 Web 服务"

### 步骤 4: 获取安全密钥 (可选但推荐)
1. 点击"安全密钥"
2. 点击"获取安全密钥"
3. 复制 `securityJsCode`

### 步骤 5: 配置到项目

后端现在通过环境变量统一管理配置，并通过 `/config.js` 接口动态注入到前端。

在 `backend/.env` 文件中添加（或完善）以下公开变量:

```env
# Supabase 前端配置
PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJxxx...

# 高德地图配置
PUBLIC_AMAP_KEY=你的Web端JS_API_Key    # 必填：前端加载地图 SDK 使用
PUBLIC_AMAP_SECURITY_CODE=你的安全密钥  # 可选：JS 安全密钥，增强安全性
PUBLIC_AMAP_REST_KEY=你的Web服务Key      # 必填：POI/地理编码等 REST 接口使用
```

> ⚠️ **重要**：`PUBLIC_AMAP_KEY` 和 `PUBLIC_AMAP_REST_KEY` 必须是两个不同的 Key，不能共用！

### 步骤 6: 重启后端服务

修改 `.env` 文件后，需要重启后端服务使配置生效：

```bash
# 如果使用 PowerShell
.\start.ps1

# 或者手动重启
# Ctrl+C 停止后端
# cd backend && npm start
```

重启后，后端会自动读取 `PUBLIC_*` 变量并通过 `/config.js` 接口提供给前端。

### 验证配置

访问以下 URL 检查配置是否正确：

```bash
curl http://localhost:3001/config.js
```

应该返回类似以下内容：

```javascript
window.__APP_CONFIG__ = {
  "supabaseUrl": "https://xxxxx.supabase.co",
  "supabaseAnonKey": "eyJxxx...",
  "amapKey": "你的Key",
  "amapSecurityCode": "你的安全密钥",
  "amapRestKey": "你的Web服务Key"
};
```

## 📝 配置示例

### 完整的 backend/.env 配置

> 💡 **配置说明**：
> - `AI_TEXT_PROVIDERS_JSON` 和 `AI_IMAGE_PROVIDERS_JSON` 使用 JSON 格式配置多个提供商
> - `PUBLIC_*` 变量会在后端启动时通过 `/config.js` 接口提供给前端
> - MCP 工具配置是可选的，用于增强 AI 聊天的功能

### 前端自动获取配置

前端无需单独配置环境变量，启动时会自动从后端获取：

```javascript
// 前端代码自动从 /config.js 获取配置
const config = window.__APP_CONFIG__;
console.log(config.amapKey);        // 高德 JS Key
console.log(config.amapRestKey);    // 高德 Web 服务 Key
console.log(config.supabaseUrl);    // Supabase URL
```

## 🗺️ 功能说明

### 当前实现的功能:

1. **路线规划** (`AMap.Driving`)
   - 自动计算多个景点之间的路线

2. **标记点** (`AMap.Marker`)
   - 每个景点显示数字标记 (1, 2, 3...)
   - 蓝色标签样式,清晰易辨
   - 点击标记弹出详细信息

3. **信息窗口** (`AMap.InfoWindow`)
   - 点击标记显示景点名称
   - 显示站点编号

4. **自动适配视野**
   - 自动调整地图缩放和中心点
   - 确保所有景点都在可视范围内


## 🎨 地图样式

当前使用的地图样式: `amap://styles/fresh` (清新风格)

可选样式:
- `amap://styles/normal` - 标准样式
- `amap://styles/dark` - 暗黑风格
- `amap://styles/light` - 月光银风格
- `amap://styles/whitesmoke` - 远山黛风格
- `amap://styles/fresh` - 草色青风格 ✅ 当前
- `amap://styles/grey` - 雅士灰风格
- `amap://styles/graffiti` - 涂鸦风格
- `amap://styles/macaron` - 马卡龙风格
- `amap://styles/blue` - 极夜蓝风格
- `amap://styles/darkblue` - 靛青蓝风格
- `amap://styles/wine` - 酱籽风格

## 🔧 高级配置


### 更换地图样式

在 `MapView.vue` 的 `initMap()` 中修改:
```javascript
map.value = new AMap.Map('amap-container', {
  mapStyle: 'amap://styles/dark', // 改为暗黑风格
});
```

## ⚠️ 注意事项

1. **API Key 安全**:
   - ✅ 使用环境变量,不要硬编码
   - ✅ `.env` 文件已在 `.gitignore` 中
   - ✅ 建议在高德控制台设置"域名白名单"或"IP白名单"

2. **配额限制**:
   - 个人开发者账号: 每日调用量有限制
   - 路线规划: 每日限额需查看控制台
   - 超出限额需升级套餐或申请增加配额

3. **坐标系统**:
   - 高德地图使用 **GCJ-02** 坐标系 (中国加密坐标)
   - LLM 返回的经纬度应该是 WGS-84 标准坐标
   - 高德 API 会自动处理坐标转换

4. **路线规划限制**:
   - 途经点数量有限制 (通常最多 16 个)
   - 如果景点过多,可能需要分段规划

## 🐛 常见问题

### Q: 地图不显示或显示空白?
A: 检查:
1. `.env` 文件中 `VITE_AMAP_KEY` 是否配置
2. 浏览器控制台是否有 API 加载错误
3. 高德控制台中 Key 是否正确配置为 "Web端(JS API)"

### Q: 调用地理编码/POI 搜索出现 `USERKEY_PLAT_NOMATCH` ?
A: 说明使用了 JS Key 访问 Web 服务接口。
1. 确认 `.env` 中已经配置 `PUBLIC_AMAP_REST_KEY`
2. 该值必须来自“Web服务”类型的 Key，不能与 JS Key 共用
3. 保存 `.env` 后重启后端，再刷新前端页面

### Q: 路线不显示,只有标记点?
A: 可能原因:
1. 景点数量少于 2 个 (至少需要起点+终点)
2. 路线规划失败 (查看控制台警告)
3. 两个景点距离过远或无法规划路线

## 📚 参考文档

- [高德地图 JS API 官方文档](https://lbs.amap.com/api/javascript-api/summary)
- [路线规划 API 文档](https://lbs.amap.com/api/javascript-api/reference/route-search#m_DrivingOptions)
- [地图样式列表](https://lbs.amap.com/api/javascript-api/guide/create-map/map-style)
