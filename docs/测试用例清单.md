# 拾光绘旅 - 测试用例清单

> 本文档基于最新代码生成，涵盖所有核心功能的测试用例

---

## 📋 目录

1. [用户认证与授权](#1-用户认证与授权)
2. [智能行程规划](#2-智能行程规划)
3. [AI 对话功能](#3-ai-对话功能)
4. [AI 速记卡片](#4-ai-速记卡片)
5. [尺素锦书（明信片）](#5-尺素锦书明信片)
6. [听见山河（BGM歌单）](#6-听见山河bgm歌单)
7. [妙笔云章（分享文案）](#7-妙笔云章分享文案)
8. [地图功能](#8-地图功能)
9. [数据持久化](#9-数据持久化)
10. [系统配置与环境](#10-系统配置与环境)

---

## 1. 用户认证与授权

### 1.1 用户登录（邮箱 OTP 方式）

**用例 ID**: UC-AUTH-001

**前置条件**:
- 后端服务已启动（端口 3001）
- 前端服务已启动（端口 8080）
- Supabase 数据库已正确配置
- 用户拥有可用的邮箱地址

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 打开浏览器访问 `http://localhost:8080` | 首页加载成功 |
| 2 | 点击右上角"登录"按钮 | 弹出登录对话框 |
| 3 | 在邮箱输入框输入: `test@example.com` | 输入框显示邮箱地址 |
| 4 | 点击"发送登录链接"按钮 | 按钮显示"发送中..." |
| 5 | 等待提示信息 | 显示"登录链接已发送，请查收邮件！" |
| 6 | 对话框自动关闭 | - |
| 7 | 打开邮箱应用 | 收到来自 Supabase 的登录邮件 |
| 8 | 点击邮件中的"登录"链接 | 跳转到应用并自动登录 |
| 9 | 查看右上角按钮 | 按钮显示用户邮箱 `test@example.com` |

**测试数据**:
- 测试邮箱: `test@example.com`
- 邮件主题: `Login link for 拾光绘旅`
- 邮件内容: 包含登录链接，链接中包含 access token

**API 调用**:

```javascript
// 发送 OTP 登录链接
await supabase.auth.signInWithOtp({
  email: 'test@example.com',
  options: {
    emailRedirectTo: 'http://localhost:8080/'
  }
});

// 响应
{
  data: {},
  error: null
}
```

**邮件验证**:

```bash
# 在邮箱中检查登录邮件
# 预期内容：
From: no-reply@supabase.io
Subject: Login link for 拾光绘旅

Body:
Hi there,

To complete your login, click the button below:
[Log In]

If you did not request this login link, please ignore this email.
```

**异常测试**:
- **A1**: 输入无效邮箱格式 → 显示"请输入有效的邮箱地址"
- **A2**: 输入空邮箱 → 显示"请输入邮箱地址"
- **A3**: Supabase 服务不可用 → 显示"认证服务暂不可用，请检查网络连接或稍后再试"
- **A4**: 网络中断 → 显示"登录失败，请稍后再试"

---

### 1.2 用户登出

**用例 ID**: UC-AUTH-002

**前置条件**:
- 用户已通过 OTP 链接登录成功

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 查看右上角登录状态 | 按钮显示用户邮箱 |
| 2 | 点击用户邮箱按钮 | 下拉菜单展开 |
| 3 | 点击"退出登录"菜单项 | 提示"已退出登录" |
| 4 | 查看右上角按钮 | 按钮变回"登录" |
| 5 | 刷新浏览器页面 | 仍然显示未登录状态 |
| 6 | 访问"我的计划"页面 | 提示"登录后查看历史记录" |

**API 调用**:

```javascript
// 登出
await supabase.auth.signOut();

// 响应
{
  data: {},
  error: null
}
```

**LocalStorage 清理验证**:

```javascript
// 验证登录状态已清除
console.log(localStorage.getItem('sb-access-token')); // null
console.log(localStorage.getItem('sb-refresh-token')); // null
```

**异常测试**:
- **A1**: 网络中断 → 可能提示"退出登录失败"，但本地状态已清除
- **A2**: 重复点击登出 → 保持未登录状态

---

### 1.3 自动会话恢复

**用例 ID**: UC-AUTH-003

**前置条件**:
- 用户已通过 OTP 链接登录成功

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 查看右上角登录状态 | 按钮显示用户邮箱 |
| 2 | 按 F5 刷新浏览器页面 | 登录状态保持，按钮仍显示用户邮箱 |
| 3 | 关闭浏览器标签页 | - |
| 4 | 重新打开浏览器，访问 `http://localhost:8080` | 自动登录成功，按钮显示用户邮箱 |
| 5 | 打开新的浏览器标签页，访问 `http://localhost:8080` | 登录状态同步，新标签页显示用户邮箱 |
| 6 | 在任意标签页点击"退出登录" | 所有标签页的登录状态同步清除 |

**Supabase Session 恢复机制**:

```javascript
// Supabase 自动检测 URL 中的 session
// 当用户从邮件链接返回时：
// URL 示例: http://localhost:8080/#access_token=xxx&refresh_token=xxx
// Supabase 会自动:
// 1. 提取 token
// 2. 保存到 localStorage
// 3. 触发 onAuthStateChange 事件

// 监听认证状态变化
supabase.auth.onAuthStateChange((event, session) => {
  console.log(event, session);
  // event: 'SIGNED_IN' | 'SIGNED_OUT' | 'TOKEN_REFRESHED'
  // session: 当前会话信息
});
```

**Token 自动刷新验证**:

| 场景 | 预期行为 |
|------|----------|
| Access token 即将过期 | Supabase 自动使用 refresh token 刷新 |
| Refresh token 过期 | 提示用户重新登录 |
| Token 刷新成功 | 用户无感知，继续正常使用 |

**异常测试**:
- **A1**: LocalStorage 被清除 | 登录状态丢失，需要重新登录 |
- **A2**: Token 损坏 | Supabase 自动清除损坏的 session，返回未登录状态 |
- **A3**: 检测到 URL 中的 session 时网络断开 | 显示"登录失败，请重试"

---

## 2. 智能行程规划

### 2.1 快捷输入解析

**用例 ID**: UC-PLAN-001

**前置条件**:
- 用户已进入智能规划页面 (`/planner`)

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在"快捷输入"文本框中输入: "我想去北京玩5天，预算1万元，2个人，喜欢美食和动漫" | 文本显示正常 |
| 2 | 点击"自动解析"按钮 | 按钮显示"解析中..." |
| 3 | 等待解析完成 | 表单字段自动填充：<br/>- 目的地: 北京<br/>- 时长: 5 天<br/>- 预算: 10000 元<br/>- 人数: 2 人<br/>- 偏好: 喜欢美食和动漫 |

**测试数据**:

| 快捷输入 | 预期解析结果 |
|----------|--------------|
| 去日本东京玩3天 | 目的地: 日本东京, 时长: 3, 预算: null, 人数: null |
| 预算3万去云南7天，4个人 | 目的地: 云南, 时长: 7, 预算: 30000, 人数: 4 |
| 周末去上海，带小孩，需要无障碍设施 | 目的地: 上海, 时长: null, 预算: null, 人数: null, 偏好: 带小孩，需要无障碍设施 |

**异常测试**:
- **A1**: 输入空内容 → 提示"快捷输入或文本为必填项"
- **A2**: AI 服务无响应 → 显示"解析失败，请重试"
- **A3**: 解析结果格式错误 → 显示为原始文本

---

### 2.2 语音输入目的地

**用例 ID**: UC-PLAN-002

**前置条件**:
- 浏览器支持语音识别（Chrome/Edge）
- 用户已授予麦克风权限

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击目的地输入框旁的麦克风图标 | 图标变为"停止录音" |
| 2 | 说出目的地: "我想去杭州西湖" | 实时显示识别结果 |
| 3 | 点击"停止录音" | 识别结果填充到输入框 |

**测试数据**:
- 中文语音: "北京天安门" → "北京天安门"
- 英文语音: "Tokyo" → "Tokyo"（可能需要额外测试）

**异常测试**:
- **A1**: 未授予麦克风权限 → 提示"请允许麦克风访问"
- **A2**: 识别失败 → 保持原有输入不变
- **A3**: 浏览器不支持语音识别 → 麦克风按钮禁用

---

### 2.3 手动填写表单

**用例 ID**: UC-PLAN-003

**前置条件**:
- 用户已进入智能规划页面

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在"目的地"输入框输入: "成都" | 输入框显示"成都" |
| 2 | 调整"时长"为: 3 天 | 数值显示 3 |
| 3 | 调整"预算"为: 8000 元 | 数值显示 8000 |
| 4 | 调整"人数"为: 2 人 | 数值显示 2 |
| 5 | 在"偏好与需求"输入框输入: "喜欢美食和历史文化" | 文本显示正常 |
| 6 | 验证表单有效性 | "生成旅行方案"按钮可点击 |

**边界值测试**:

| 字段 | 最小值 | 最大值 | 测试结果 |
|------|--------|--------|----------|
| 时长 | 1 | 30 | 正常接受 |
| 预算 | 0 | 1,000,000 | 正常接受 |
| 人数 | 1 | 20 | 正常接受 |

**异常测试**:
- **A1**: 目的地为空 → "生成旅行方案"按钮禁用
- **A2**: 时长为 0 → "生成旅行方案"按钮禁用
- **A3**: 超出最大值 → 按钮禁用或自动修正

---

### 2.4 生成旅行计划

**用例 ID**: UC-PLAN-004

**前置条件**:
- 表单数据已填写完整
- 后端 AI 服务正常

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 填写表单数据：<br/>- 目的地: 北京<br/>- 时长: 3 天<br/>- 预算: 10000 元<br/>- 人数: 2 人<br/>- 偏好: 喜欢美食和历史 | - |
| 2 | 点击"生成旅行方案"按钮 | 按钮显示"正在生成方案..." |
| 3 | 等待生成完成（约 30-60 秒） | 生成成功，跳转到方案详情页 |
| 4 | 查看方案详情 | 显示完整的 3 天行程：<br/>- 每天主题<br/>- 活动列表（时间、地点、描述）<br/>- 酒店推荐<br/>- 预算分解<br/>- 旅行提示 |

**预期返回数据结构**:

```json
{
  "isStructured": true,
  "plan": {
    "destination": "北京",
    "duration": 3,
    "total_budget": 10000,
    "daily_itinerary": [
      {
        "day": 1,
        "theme": "探索古都风情",
        "hotel": {
          "name": "北京王府井希尔顿酒店",
          "address": "北京市东城区王府井东街8号",
          "price_range": "800-1200元/晚"
        },
        "activities": [
          {
            "time": "09:00-12:00",
            "location": "天安门广场",
            "address": "北京市东城区长安街",
            "description": "参观世界最大的城市广场，感受首都的庄严与壮丽",
            "coords": [116.397128, 39.903738]
          },
          {
            "time": "14:00-17:00",
            "location": "故宫博物院",
            "address": "北京市东城区景山前街4号",
            "description": "游览明清两代皇家宫殿，感受中华文明的博大精深",
            "coords": [116.397477, 39.918058]
          }
        ]
      }
    ],
    "accommodation": [
      {
        "name": "北京王府井希尔顿酒店",
        "address": "北京市东城区王府井东街8号",
        "price_range": "800-1200元/晚",
        "rating": "4.5",
        "features": ["交通便利", "设施完善"]
      }
    ],
    "restaurants": [
      {
        "name": "全聚德烤鸭店",
        "cuisine": "北京菜",
        "price_range": "200-400元/人",
        "specialty": "北京烤鸭"
      }
    ],
    "transport": {
      "local": "地铁2号线、公交",
      "recommended": "使用公交+地铁出行，经济便捷"
    },
    "budget_breakdown": {
      "transportation": 1500,
      "accommodation": 2400,
      "meals": 3000,
      "attractions": 2000,
      "tickets": 500,
      "shopping": 600,
      "other": 0
    },
    "tips": [
      "提前在官网预约故宫门票",
      "北京烤鸭建议提前2小时预约",
      "地铁是北京出行最便捷的方式"
    ]
  }
}
```

**异常测试**:
- **A1**: AI 服务超时 → 显示"生成超时，请重试"
- **A2**: 后端服务不可用 → 显示"服务暂时不可用"
- **A3**: 返回格式错误 → 显示原始文本或提示错误

---

### 2.5 使用 MCP 工具增强规划

**用例 ID**: UC-PLAN-005

**前置条件**:
- 已配置 MCP 工具（12306、高德地图、Bing）
- AI 文本提供商支持工具调用

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 填写表单，包含跨城市旅行：<br/>- 目的地: 上海到杭州<br/>- 时长: 2 天<br/>- 人数: 1 人 | - |
| 2 | 点击"生成旅行方案"按钮 | 开始生成，AI 调用 MCP 工具 |
| 3 | 查看生成过程（如果开启调试） | AI 调用 12306 工具查询火车票<br/>AI 调用高德地图查询景点位置<br/>AI 调用 Bing 搜索最新信息 |
| 4 | 查看最终方案 | 方案包含真实信息：<br/>- 实际车次和票价<br/>- 景点实际开放时间<br/>- 酒店实时价格（如果有） |

**测试场景**:

| 场景 | 预期调用的工具 | 验证点 |
|------|----------------|--------|
| 查询火车票 | 12306-mcp | 返回真实车次、时间、价格 |
| 查询景点信息 | amap-maps | 返回景点位置、开放时间、门票 |
| 搜索最新攻略 | bing-search | 返回相关网页链接或摘要 |

**异常测试**:
- **A1**: MCP 工具配置错误 → 正常生成，不使用工具
- **A2**: 工具调用超时 → 使用默认信息或降级方案
- **A3**: 工具返回空结果 → 继续生成，给出提示

---

### 2.6 保存旅行计划

**用例 ID**: UC-PLAN-006

**前置条件**:
- 用户已登录
- 已生成旅行计划
- Supabase 数据库连接正常

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在方案详情页，点击"保存方案"按钮 | 按钮显示"保存中..." |
| 2 | 等待保存完成 | 显示"保存成功"提示 |
| 3 | 导航到"我的计划"页面 | 显示刚保存的计划 |
| 4 | 点击计划卡片 | 加载计划详情 |

**数据库验证**:

```sql
-- 验证计划是否保存到数据库
SELECT id, user_id, destination, duration, budget, created_at
FROM travel_plans
WHERE user_id = '当前用户ID'
ORDER BY created_at DESC
LIMIT 1;
```

**异常测试**:
- **A1**: 用户未登录 → 提示"请先登录"
- **A2**: 数据库连接失败 → 显示"保存失败，请重试"
- **A3**: 保存到一半断网 → 恢复后重新尝试

---

### 2.7 查看已保存计划

**用例 ID**: UC-PLAN-007

**前置条件**:
- 用户已登录
- 至少保存了一个旅行计划

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 导航到"我的计划"页面 (`/saved`) | 显示所有已保存的计划 |
| 2 | 查看计划列表 | 每个计划显示：<br/>- 目的地<br/>- 时长<br/>- 预算<br/>- 创建时间<br/>- 缩略图（如果有） |
| 3 | 点击某个计划卡片 | 跳转到该计划的详情页 |
| 4 | 在详情页，点击"编辑"按钮 | 进入编辑模式 |

**异常测试**:
- **A1**: 没有保存的计划 | 显示"暂无保存的计划" |
| **A2**: 数据加载失败 | 显示"加载失败，请刷新重试" |

---

### 2.8 删除旅行计划

**用例 ID**: UC-PLAN-008

**前置条件**:
- 用户已登录
- 至少有一个已保存的计划

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在"我的计划"页面，找到要删除的计划 | - |
| 2 | 点击计划卡片上的删除按钮 | 弹出确认对话框 |
| 3 | 点击"确认删除" | 计划被删除，列表更新 |
| 4 | 刷新页面 | 计划仍然不存在 |

**数据库验证**:

```sql
-- 验证计划是否已删除
SELECT id, destination, deleted_at
FROM travel_plans
WHERE id = '已删除的计划ID';
```

**异常测试**:
- **A1**: 点击"取消" | 对话框关闭，计划保留 |
| **A2**: 删除时网络中断 | 提示"删除失败，请重试" |

---

## 3. AI 对话功能

### 3.1 普通对话模式

**用例 ID**: UC-CHAT-001

**前置条件**:
- 用户已进入"AI面对面对话"页面 (`/ai-chat`)
- AI 文本提供商已配置

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在输入框输入: "北京有哪些必去的景点？" | 输入框显示问题 |
| 2 | 点击"发送"按钮或按回车键 | AI 开始回答，显示流式响应 |
| 3 | 等待回答完成 | 完整显示 AI 回答内容 |
| 4 | 继续对话: "故宫和天安门离得近吗？" | AI 基于上下文继续回答 |

**预期响应格式**:

```json
{
  "conversation_id": "uuid-session-id",
  "ai_response": "北京有许多必去的经典景点...",
  "providers": [
    {
      "kind": "text",
      "provider": "gitcode",
      "model": "Kimi-K2"
    }
  ]
}
```

**测试数据**:

| 用户问题 | 预期 AI 回答特点 |
|----------|------------------|
| 北京有哪些必去的景点？ | 列举 3-5 个著名景点，并简单介绍 |
| 推荐一些北京的特色美食 | 列举北京特色小吃，说明特色 |
| 3天在北京怎么玩？ | 给出大致的 3 天行程建议 |

**异常测试**:
- **A1**: 输入为空 | 提示"请输入消息" |
| **A2**: AI 服务超时 | 显示"回答超时，请重试" |
| **A3**: AI 提供商全部失败 | 显示"AI 服务暂时不可用" |

---

### 3.2 工具模式对话

**用例 ID**: UC-CHAT-002

**前置条件**:
- MCP 工具已配置
- AI 文本提供商支持工具调用

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 打开"工具模式"开关 | 开关状态变为"工具模式" |
| 2 | 输入: "查一下明天从北京到杭州的火车票" | AI 调用 12306 工具 |
| 3 | 等待工具调用和回答完成 | 显示真实的车次信息：<br/>- 车次号<br/>- 出发/到达时间<br/>- 价格<br/>- 余票情况 |
| 4 | 继续问: "上海外滩附近有什么好吃的？" | AI 调用高德地图工具查询 |

**测试场景**:

| 用户问题 | 预期调用的工具 | 验证点 |
|----------|----------------|--------|
| 查询火车票 | 12306-mcp | 返回真实车次、时间、价格 |
| 查找附近的餐厅 | amap-maps | 返回餐厅列表、位置、评分 |
| 搜索最新旅游攻略 | bing-search | 返回相关网页链接或摘要 |

**验证工具调用**:

```bash
# 查看后端日志，确认工具调用
# 日志应包含类似以下内容：
[MCP] Calling tool: 12306-mcp.search_tickets
[MCP] Tool result: { "trains": [...] }
```

**异常测试**:
- **A1**: 工具调用超时 | AI 提示"工具调用超时，请重试" |
| **A2**: 工具返回空结果 | AI 提示"未找到相关信息" |
| **A3**: MCP 工具未配置 | 自动降级到普通模式 |

---

### 3.3 语音合成（TTS）

**用例 ID**: UC-CHAT-003

**前置条件**:
- AI 回答已生成

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在对话消息旁点击"播放语音"按钮 | 按钮变为加载状态 |
| 2 | 等待语音合成完成 | 开始播放 AI 回答的语音 |
| 3 | 点击"暂停"按钮 | 语音暂停播放 |
| 4 | 再次点击"播放"按钮 | 从暂停处继续播放 |

**API 调用流程**:

1. 发起 TTS 请求:
```json
POST /api/tts
{
  "text": "北京有许多必去的景点...",
  "voice": "default"
}

// 响应
{
  "taskId": "uuid-task-id"
}
```

2. 轮询任务状态:
```json
GET /api/tts/:taskId

// 响应（处理中）
{
  "status": "processing",
  "task_id": "uuid-task-id"
}

// 响应（完成）
{
  "status": "completed",
  "task_id": "uuid-task-id",
  "audio_url": "/audio/uuid-task-id.wav"
}
```

**异常测试**:
- **A1**: TTS 服务不可用 | 显示"语音合成失败" |
| **A2**: 语音文件不存在 | 显示"音频加载失败" |
| **A3**: 播放失败 | 提示"播放失败，请重试" |

---

### 3.4 会话历史管理

**用例 ID**: UC-CHAT-004

**前置条件**:
- 用户已登录
- 至少有一个历史会话

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击"历史记录"按钮 | 展开历史会话侧边栏 |
| 2 | 查看会话列表 | 显示所有历史会话：<br/>- 会话标题（自动生成）<br/>- 消息数量<br/>- 更新时间 |
| 3 | 点击某个会话 | 加载该会话的对话历史 |
| 4 | 在历史会话中继续对话 | 新消息添加到该会话 |
| 5 | 点击会话卡片上的删除按钮 | 弹出确认对话框 |
| 6 | 确认删除 | 会话被删除 |

**API 调用**:

```bash
# 获取会话列表
GET /api/ai-chat/sessions

# 响应
{
  "sessions": [
    {
      "conversation_id": "uuid-1",
      "title": "北京旅游攻略",
      "message_count": 15,
      "updated_at": "2026-01-20T10:30:00.000Z",
      "created_at": "2026-01-19T15:20:00.000Z"
    }
  ]
}

# 获取会话历史
GET /api/ai-chat/sessions/:id/history

# 响应
{
  "messages": [
    {
      "role": "user",
      "content": "北京有哪些必去的景点？",
      "timestamp": "2026-01-19T15:20:00.000Z"
    },
    {
      "role": "assistant",
      "content": "北京有许多必去的经典景点...",
      "timestamp": "2026-01-19T15:20:05.000Z"
    }
  ]
}

# 删除会话
DELETE /api/ai-chat/sessions/:id
```

**异常测试**:
- **A1**: 用户未登录 | 提示"登录后查看历史记录" |
| **A2**: 会话加载失败 | 显示"加载失败，请重试" |
| **A3**: 删除会话失败 | 提示"删除失败，请重试" |

---

### 3.5 新建对话

**用例 ID**: UC-CHAT-005

**前置条件**:
- 用户已在对话页面

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击"新对话"按钮 | 清空当前对话内容 |
| 2 | 输入新消息 | 创建新的会话 ID |
| 3 | 查看历史记录 | 新会话出现在列表顶部 |

**异常测试**:
- **A1**: 创建会话失败 | 提示"创建失败，请重试" |

---

### 3.6 MCP 工具状态检查

**用例 ID**: UC-CHAT-006

**前置条件**:
- 已配置 MCP 工具

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在工具模式下，查看工具状态 | 显示已配置的工具：<br/>- 工具名称<br/>- 工具状态（可用/不可用）<br/>- 可用工具数量 |

**API 调用**:

```bash
GET /api/ai-chat/mcp/status?scope=summary

# 响应
{
  "tool_probe": {
    "ok": true,
    "tools": [
      {
        "name": "12306-mcp",
        "status": "available",
        "description": "火车票查询"
      },
      {
        "name": "amap-maps",
        "status": "available",
        "description": "高德地图服务"
      }
    ]
  },
  "providers": {
    "text": 2,
    "image": 1
  }
}
```

**异常测试**:
- **A1**: MCP 工具未配置 | 显示"暂未配置 MCP 工具" |
| **A2**: 工具探查超时 | 显示"工具状态检查超时" |

---

## 4. AI 速记卡片

### 4.1 生成速记卡片

**用例 ID**: UC-CARD-001

**前置条件**:
- 用户已生成或加载旅行计划
- 图片生成提供商已配置

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在方案详情页，点击"拾光·绘影"按钮 | 跳转到速记卡片页面 |
| 2 | 等待生成完成 | 显示以下步骤：<br/>1. 生成提示词（✓）<br/>2. AI 绘图（✓）<br/>3. 完成（✓） |
| 3 | 查看生成的卡片 | 显示精美的旅行速记卡片：<br/>- 目的地名称<br/>- 关键景点或活动<br/>- 艺术风格的背景图<br/>- 旅行日期或标语 |

**API 调用**:

```json
POST /api/prompt/optimize
{
  "destination": "北京",
  "dailyItinerary": [
    {
      "day": 1,
      "theme": "探索古都风情",
      "activities": [
        {
          "location": "天安门广场",
          "description": "参观世界最大的城市广场"
        }
      ]
    }
  ]
}

// 响应
{
  "optimizedPrompt": "A beautiful travel card for Beijing, featuring Tiananmen Square in the foreground, with traditional Chinese architectural elements in the background, soft warm lighting, artistic watercolor style, minimal design, elegant typography"
}

// 然后调用图片生成
POST /api/image/generate
{
  "prompt": "A beautiful travel card for Beijing...",
  "style": "artistic",
  "size": "1024x1024",
  "provider": "modelscope"
}

// 响应
{
  "url": "https://generated-image-url...",
  "provider": "modelscope",
  "prompt": "A beautiful travel card for Beijing..."
}
```

**测试数据**:

| 目的地 | 预期卡片特点 |
|--------|--------------|
| 北京 | 红墙黄瓦、古建筑元素 |
| 上海 | 现代都市、外滩天际线 |
| 杭州 | 西湖、江南水乡风格 |

**异常测试**:
- **A1**: 提示词生成失败 | 显示"提示词生成失败，请重试" |
| **A2**: 图片生成超时 | 显示"图片生成超时，请重试" |
| **A3**: 图片提供商不可用 | 显示"图片生成服务暂时不可用" |

---

### 4.2 更换图片提供商

**用例 ID**: UC-CARD-002

**前置条件**:
- 已配置多个图片提供商

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在速记卡片页面，查看"图片引擎"下拉框 | 显示所有可用提供商 |
| 2 | 选择不同的提供商（如 ModelScope） | 提供商切换成功 |
| 3 | 点击"重新生成"按钮 | 使用新的提供商生成卡片 |
| 4 | 查看生成结果 | 显示使用新提供商生成的卡片 |

**API 调用**:

```bash
# 获取可用提供商
GET /api/image/providers

# 响应
{
  "providers": [
    {
      "id": "modelscope",
      "name": "魔搭社区",
      "icon": "app"
    }
  ],
  "default": "modelscope"
}
```

**异常测试**:
- **A1**: 提供商切换失败 | 保持原提供商 |
| **A2**: 提供商生成失败 | 自动降级到其他提供商 |

---

### 4.3 下载卡片

**用例 ID**: UC-CARD-003

**前置条件**:
- 卡片已生成

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击卡片上的"下载"按钮 | 开始下载图片文件 |
| 2 | 选择保存位置 | 文件下载到本地 |
| 3 | 查看下载的图片 | 图片完整、清晰 |

**异常测试**:
- **A1**: 图片链接失效 | 提示"图片加载失败" |
| **A2**: 下载失败 | 提示"下载失败，请重试" |

---

## 5. 尺素锦书（明信片）

### 5.1 生成明信片

**用例 ID**: UC-POSTCARD-001

**前置条件**:
- 用户已生成或加载旅行计划
- 图片生成提供商已配置

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在方案详情页，点击"尺素·锦书"按钮 | 跳转到明信片页面 |
| 2 | 选择明信片风格（如：复古、现代、艺术） | 风格选择成功 |
| 3 | 选择尺寸（如：1024x1024, 1024x768） | 尺寸选择成功 |
| 4 | 点击"生成明信片"按钮 | 开始生成 |
| 5 | 等待生成完成 | 显示精美的旅行明信片：<br/>- 目的地特色景观<br/>- 诗意或祝福语<br/>- 日期或地点标记<br/>- 传统明信片设计元素 |

**API 调用**:

```json
POST /api/postcard/generate
{
  "destination": "北京",
  "dailyItinerary": [...],
  "style": "artistic",
  "size": "1024x1024"
}

// 响应
{
  "url": "https://generated-postcard-url...",
  "provider": "modelscope",
  "prompt": "A beautiful postcard of Beijing with traditional Chinese design..."
}
```

**测试数据**:

| 风格 | 预期特点 |
|------|----------|
| 复古 | 怀旧色调、传统边框 |
| 现代 | 简洁设计、大胆配色 |
| 艺术 | 抽象元素、独特构图 |

**异常测试**:
- **A1**: 风格选择失败 | 使用默认风格 |
| **A2**: 生成超时 | 显示"生成超时，请重试" |

---

## 6. 听见山河（BGM歌单）

### 6.1 生成 BGM 歌单

**用例 ID**: UC-PLAYLIST-001

**前置条件**:
- 用户已生成或加载旅行计划

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在方案详情页，点击"听见·山河"按钮 | 弹出歌单配置模态框 |
| 2 | 选择行程风格（如：🎵 古典之旅、🎵 浪漫之旅） | 风格选择成功 |
| 3 | 或在自定义风格输入框输入："亲子游" | 自定义风格设置成功 |
| 4 | 点击"生成歌单"按钮 | 开始生成 |
| 5 | 等待生成完成 | 显示 BGM 歌单：<br/>- 歌单名称（自动生成）<br/>- 歌曲列表（10-15 首）<br/>- 每首歌的：<br/>  - 歌曲名称<br/>  - 演唱者<br/>  - 时长<br/>  - 风格标签 |

**API 调用**:

```json
POST /api/playlist/generate
{
  "destination": "北京",
  "duration": 3,
  "style": "古典之旅",
  "dailyItinerary": [...]
}

// 响应
{
  "title": "古都北京·三日游 BGM",
  "songs": [
    {
      "name": "北京北京",
      "artist": "汪峰",
      "duration": "4:32",
      "style": "摇滚"
    },
    {
      "name": "北京一夜",
      "artist": "信乐团",
      "duration": "5:10",
      "style": "流行"
    }
  ],
  "totalDuration": "45:23",
  "songCount": 10
}
```

**测试数据**:

| 行程风格 | 预期歌曲风格 |
|----------|--------------|
| 🎵 古典之旅 | 古典音乐、民族音乐 |
| 🎵 浪漫之旅 | 抒情歌曲、轻音乐 |
| 🎵 活力之旅 | 流行音乐、电子音乐 |
| 自定义：亲子游 | 欢快歌曲、童谣 |

**异常测试**:
- **A1**: 歌单生成失败 | 显示"生成失败，请重试" |
| **A2**: AI 服务超时 | 显示"生成超时，请重试" |

---

### 6.2 播放歌曲预览

**用例 ID**: UC-PLAYLIST-002

**前置条件**:
- 歌单已生成

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击某首歌曲的"播放"按钮 | 开始播放歌曲预览 |
| 2 | 调整音量 | 音量变化正常 |
| 3 | 点击"暂停"按钮 | 歌曲暂停 |
| 4 | 点击其他歌曲的"播放"按钮 | 切换到新歌曲 |

**异常测试**:
- **A1**: 音频文件不存在 | 显示"播放失败，请重试" |
| **A2**: 播放器加载失败 | 提示"播放器加载失败" |

---

## 7. 妙笔云章（分享文案）

### 7.1 生成分享文案

**用例 ID**: UC-SHARE-001

**前置条件**:
- 用户已生成或加载旅行计划

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在方案详情页，点击"妙笔·云章"按钮 | 弹出分享文案配置模态框 |
| 2 | 选择平台（如：小红书、朋友圈、抖音） | 平台选择成功 |
| 3 | 选择情感（如：🥰 开心、😊 轻松、🤔 怀念） | 情感选择成功 |
| 4 | 选择亮点（多选）：<br/>- 美食体验<br/>- 文化探索<br/>- 自然风光 | 亮点选择成功 |
| 5 | 点击"生成文案"按钮 | 开始生成 |
| 6 | 等待生成完成 | 显示符合平台风格的分享文案：<br/>- 吸引人的标题<br/>- 生动的正文<br/>- 适当的 Emoji<br/>- 相关的话题标签（#） |

**API 调用**:

```json
POST /api/share/generate
{
  "destination": "北京",
  "duration": 3,
  "platform": "xiaohongshu",
  "emotion": "开心",
  "highlights": ["美食体验", "文化探索"],
  "dailyItinerary": [...]
}

// 响应
{
  "content": "标题：三天两夜北京之旅，吃遍老北京的味道！🍜\n\n这次去北京简直太开心了！三天的行程满满当当，不仅打卡了故宫、天安门这些经典景点，还尝遍了老北京的美食！🥟\n\n✨ 亮点体验：\n🥟 全聚德烤鸭真的是一绝，皮脆肉嫩，值得一试！\n🏯 故宫的气势让人震撼，一定要提前预约哦~\n🚇 北京的地铁超方便，出行完全不用愁！\n\n如果你也喜欢历史和美食，北京绝对是你的不二之选！💕\n\n#北京旅游 #故宫 #美食之旅 #旅行vlog",
  "destination": "北京",
  "duration": 3,
  "platform": "xiaohongshu",
  "platformName": "小红书",
  "emotion": "开心",
  "highlights": ["美食体验", "文化探索"],
  "timestamp": "2026-01-20T10:30:00.000Z"
}
```

**测试数据**:

| 平台 | 文案特点 |
|------|----------|
| 小红书 | 丰富的 Emoji、话题标签、推荐语气 |
| 朋友圈 | 简洁、生活化、适合配图 |
| 抖音 | 吸睛标题、短句、鼓励互动 |

**异常测试**:
- **A1**: 文案生成失败 | 显示"生成失败，请重试" |
- **A2**: AI 服务超时 | 显示"生成超时，请重试" |

---

### 7.2 复制文案

**用例 ID**: UC-SHARE-002

**前置条件**:
- 文案已生成

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 点击"复制文案"按钮 | 显示"已复制到剪贴板"提示 |
| 2 | 打开目标平台 | 粘贴剪贴板内容 | 文案完整粘贴 |

**异常测试**:
- **A1**: 复制失败 | 提示"复制失败，请重试" |

---

## 8. 地图功能

### 8.1 查看地图

**用例 ID**: UC-MAP-001

**前置条件**:
- 已加载旅行计划详情

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在方案详情页，查看右侧地图 | 地图正常加载 |
| 2 | 查看地图上的标记 | 显示所有活动地点的标记 |
| 3 | 点击某个标记 | 显示地点名称和简要信息 |
| 4 | 拖动地图 | 地图流畅滚动 |
| 5 | 缩放地图 | 地图流畅缩放 |

**验证点**:
- 地图使用高德地图 API
- 标记位置与行程中的地点一致
- 地图样式美观、清晰

**异常测试**:
- **A1**: 高德地图 API 未配置 | 显示"地图加载失败" |
| **A2**: 地点坐标缺失 | 该地点不显示标记 |

---

### 8.2 定位到特定地点

**用例 ID**: UC-MAP-002

**前置条件**:
- 已加载旅行计划详情

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在行程列表中，点击某个活动 | 地图自动飞到该活动地点 |
| 2 | 地图中心对准该地点的标记 | 标记高亮显示 |
| 3 | 查看地图缩放级别 | 自动调整到合适的级别 |

**异常测试**:
- **A1**: 活动无坐标 | 地图不移动，提示"该活动无坐标信息" |

---

### 8.3 路线规划

**用例 ID**: UC-MAP-003

**前置条件**:
- 已加载旅行计划详情
- 活动地点有坐标

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 查看地图上的路线 | 显示当天的活动路线 |
| 2 | 点击"显示路线"按钮（如果有） | 路线高亮显示 |
| 3 | 查看路线信息 | 显示预计时间和距离 |

**异常测试**:
- **A1**: 路线规划失败 | 显示"路线规划失败，请重试" |
| **A2**: 某些地点无法规划 | 显示部分路线，提示未规划的地点 |

---

## 9. 数据持久化

### 9.1 保存到 Supabase

**用例 ID**: UC-DB-001

**前置条件**:
- 用户已登录
- Supabase 数据库连接正常

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 生成或编辑旅行计划 | - |
| 2 | 点击"保存"按钮 | 数据保存到 Supabase |
| 3 | 在 Supabase 控制台查看表 `travel_plans` | 记录已存在 |
| 4 | 刷新页面 | 计划仍然存在 |

**数据库验证**:

```sql
-- 查看保存的计划
SELECT 
  id, 
  user_id, 
  destination, 
  duration, 
  budget, 
  preferences,
  created_at,
  updated_at
FROM travel_plans
WHERE user_id = '当前用户ID'
ORDER BY created_at DESC
LIMIT 5;

-- 查看计划详情
SELECT 
  day,
  theme,
  hotel,
  activities
FROM travel_plan_details
WHERE plan_id = '计划ID'
ORDER BY day;
```

**异常测试**:
- **A1**: 保存失败 | 提示"保存失败，请重试" |
| **A2**: 数据格式错误 | 后端验证失败，提示具体错误 |

---

### 9.2 加载历史数据

**用例 ID**: UC-DB-002

**前置条件**:
- 用户已登录
- 数据库中有历史数据

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 导航到"我的计划"页面 | 加载所有保存的计划 |
| 2 | 点击某个计划 | 加载该计划的详细数据 |
| 3 | 查看加载的数据 | 数据完整、正确 |

**异常测试**:
- **A1**: 加载失败 | 显示"加载失败，请重试" |
- **A2**: 数据损坏 | 提示"数据格式错误" |

---

### 9.3 同步多设备

**用例 ID**: UC-DB-003

**前置条件**:
- 用户在两个设备上登录同一账号

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在设备 A 上保存新计划 | 保存成功 |
| 2 | 在设备 B 上刷新"我的计划" | 显示新保存的计划 |
| 3 | 在设备 B 上修改计划 | 保存成功 |
| 4 | 在设备 A 上刷新 | 显示修改后的计划 |

**异常测试**:
- **A1**: 网络延迟 | 等待同步完成 |
| **A2**: 同步冲突 | 提示"数据冲突，请重试" |

---

## 10. 系统配置与环境

### 10.1 环境变量配置

**用例 ID**: UC-CONFIG-001

**前置条件**:
- 后端项目已克隆
- Node.js 已安装

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 复制环境变量示例文件 | `cp backend/.env.example backend/.env` |
| 2 | 编辑 `.env` 文件，配置必需变量 | - |
| 3 | 启动后端服务 | 服务正常启动 |
| 4 | 检查启动日志 | 显示"✓ All services initialized successfully" |

**必需环境变量**:

```env
# 服务器配置
PORT=3001
HOST=0.0.0.0
NODE_ENV=development

# AI 文本提供商（至少配置一个）
AI_TEXT_PROVIDERS_JSON='[
  {
    "name": "gitcode",
    "enabled": true,
    "baseURL": "https://api.gitcode.com/api/v5",
    "apiKey": "sk-your-api-key",
    "model": "Kimi-K2",
    "priority": 1
  }
]'

# AI 图片提供商（至少配置一个）
AI_IMAGE_PROVIDERS_JSON='[
  {
    "name": "modelscope",
    "enabled": true,
    "apiKey": "your-modelscope-api-key",
    "priority": 1
  }
]'

# Supabase 配置
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# 前端公开配置
PUBLIC_SUPABASE_URL=https://your-project.supabase.co
PUBLIC_SUPABASE_ANON_KEY=your-anon-key
PUBLIC_AMAP_KEY=your-amap-key
PUBLIC_AMAP_REST_KEY=your-amap-rest-key
```

**异常测试**:
- **A1**: 缺少必需变量 | 后端启动失败，提示具体缺少的变量 |
| **A2**: API 密钥无效 | 服务启动成功，但调用失败 |
- **A3**: JSON 格式错误 | 启动失败，提示 JSON 解析错误 |

---

### 10.2 高德地图 API 配置

**用例 ID**: UC-CONFIG-002

**前置条件**:
- 已获取高德地图 API Key

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在 `.env` 文件中配置高德地图 Key | 配置成功 |
| 2 | 重启后端服务 | 服务正常启动 |
| 3 | 访问 `/config.js` 接口 | 返回配置信息 |
| 4 | 访问前端，查看地图 | 地图正常加载 |

**验证配置**:

```bash
# 访问配置接口
curl http://localhost:3001/config.js

# 预期响应
window.__APP_CONFIG__ = {
  "supabaseUrl": "https://your-project.supabase.co",
  "supabaseAnonKey": "your-anon-key",
  "amapKey": "your-amap-key",
  "amapRestKey": "your-amap-rest-key"
};
```

**异常测试**:
- **A1**: Key 无效 | 地图显示"API Key 无效" |
| **A2**: Key 未配置 | 地图无法加载 |

---

### 10.3 MCP 工具配置

**用例 ID**: UC-CONFIG-003

**前置条件**:
- 已获取 MCP 工具的服务 URL 和授权信息

**测试步骤**:

| 步骤 | 操作 | 预期结果 |
|------|------|----------|
| 1 | 在 `.env` 文件中配置 MCP 工具 | 配置成功 |
| 2 | 重启后端服务 | 服务正常启动 |
| 3 | 访问 `/api/ai-chat/mcp/status` 接口 | 返回工具状态 |
| 4 | 在 AI 对话中测试工具调用 | 工具调用成功 |

**配置示例**:

```env
# 12306 火车票查询
MCP_12306_URL=https://mcp.api-inference.modelscope.net/xxx/sse
MCP_12306_AUTHORIZATION=Bearer your-token

# 高德地图服务
MCP_AMAP_URL=https://mcp.api-inference.modelscope.net/xxx/sse
MCP_AMAP_AUTHORIZATION=Bearer your-token

# Bing 搜索
MCP_BING_URL=https://mcp.api-inference.modelscope.net/xxx/sse
MCP_BING_AUTHORIZATION=Bearer your-token
```

**验证工具状态**:

```bash
# 检查 MCP 工具状态
curl http://localhost:3001/api/ai-chat/mcp/status?scope=summary

# 预期响应
{
  "tool_probe": {
    "ok": true,
    "tools": [
      {
        "name": "12306-mcp",
        "status": "available",
        "description": "火车票查询"
      }
    ]
  }
}
```

**异常测试**:
- **A1**: MCP URL 无效 | 工具状态显示不可用 |
| **A2**: 授权失败 | 工具状态显示授权失败 |

---

## 附录

### A. 测试环境配置

**前端**:
- 浏览器: Chrome 120+, Edge 120+, Safari 17+
- 分辨率: 1920x1080（桌面）, 375x667（移动端）

**后端**:
- Node.js: >= 18.0.0
- 数据库: Supabase PostgreSQL

### B. API 接口清单

| 接口路径 | 方法 | 功能 |
|----------|------|------|
| `/api/plan/parse-travel-info` | POST | 解析旅行信息 |
| `/api/plan/generate` | POST | 生成旅行计划 |
| `/api/plan/generate-complete` | POST | 生成完整旅行计划 |
| `/api/ai-chat/chat` | POST | AI 对话 |
| `/api/ai-chat/sessions` | POST | 创建会话 |
| `/api/ai-chat/sessions` | GET | 获取会话列表 |
| `/api/ai-chat/sessions/:id/history` | GET | 获取会话历史 |
| `/api/ai-chat/sessions/:id` | DELETE | 删除会话 |
| `/api/ai-chat/mcp/status` | GET | 获取 MCP 工具状态 |
| `/api/tts` | POST | 创建 TTS 任务 |
| `/api/tts/:taskId` | GET | 获取 TTS 任务状态 |
| `/api/image/generate` | POST | 生成图片 |
| `/api/image/providers` | GET | 获取图片提供商 |
| `/api/image/history` | GET | 获取生成历史 |
| `/api/playlist/generate` | POST | 生成 BGM 歌单 |
| `/api/playlist/history` | GET | 获取生成历史 |
| `/api/postcard/generate` | POST | 生成明信片 |
| `/api/share/generate` | POST | 生成分享文案 |
| `/api/prompt/optimize` | POST | 优化提示词 |
| `/health` | GET | 健康检查 |
| `/config.js` | GET | 获取前端配置 |

### C. 错误码清单

| 错误码 | 说明 |
|--------|------|
| `PLAN_TIMEOUT` | 旅行规划生成超时 |
| `MODEL_INVOKE_TIMEOUT` | AI 模型调用超时 |
| `MODEL_INVOKE_FAILED` | AI 模型调用失败 |
| `MODEL_EMPTY_RESPONSE` | AI 模型返回空结果 |
| `TOOL_INVOKE_TIMEOUT` | MCP 工具调用超时 |
| `TOOLCALL_PROBE_TIMEOUT` | MCP 工具能力探测超时 |
| `MCP_STARTUP_TIMEOUT` | MCP 启动超时 |
| `MODELSCOPE_REQUEST_LIMIT` | ModelScope 请求次数已达上限 |
| `TEXT_PROVIDER_UNAVAILABLE` | 未配置可用的文本模型提供商 |
| `IMAGE_PROVIDER_UNAVAILABLE` | 未配置可用的图片生成提供商 |
| `TEXT_PROVIDER_NOT_FOUND` | 未找到可用的文本模型提供商 |
| `TEXT_PROVIDER_ALL_FAILED` | 文本模型调用失败 |
| `IMAGE_PROVIDER_ALL_FAILED` | 图片生成失败 |

### D. 测试数据清单

**旅行计划测试数据**:

```json
{
  "destination": "北京",
  "duration": 3,
  "budget": 10000,
  "travelers": 2,
  "preferences": "喜欢美食和历史文化"
}
```

**AI 对话测试数据**:

- "北京有哪些必去的景点？"
- "推荐一些北京的特色美食"
- "故宫和天安门离得近吗？"
- "查一下明天从北京到杭州的火车票"
- "上海外滩附近有什么好吃的？"

**图片生成测试数据**:

```json
{
  "prompt": "A beautiful travel card for Beijing...",
  "style": "artistic",
  "size": "1024x1024",
  "provider": "modelscope"
}
```

**BGM 歌单测试数据**:

```json
{
  "destination": "北京",
  "duration": 3,
  "style": "古典之旅",
  "dailyItinerary": [...]
}
```

**分享文案测试数据**:

```json
{
  "destination": "北京",
  "duration": 3,
  "platform": "xiaohongshu",
  "emotion": "开心",
  "highlights": ["美食体验", "文化探索"],
  "dailyItinerary": [...]
}
```

---

**文档版本**: v1.0.0  
**最后更新**: 2026-01-20  
**生成依据**: 最新代码库分析
