# AI æ—…è¡Œè§„åˆ’ç³»ç»Ÿ - éƒ¨ç½²æŒ‡å—

## ğŸ“‹ ç›®å½•

- [éƒ¨ç½²æ–¹å¼](#éƒ¨ç½²æ–¹å¼)
- [ç¯å¢ƒå‡†å¤‡](#ç¯å¢ƒå‡†å¤‡)
- [æœ¬åœ°å¼€å‘éƒ¨ç½²](#æœ¬åœ°å¼€å‘éƒ¨ç½²)
- [Docker éƒ¨ç½²](#docker-éƒ¨ç½²)
- [Docker Compose éƒ¨ç½²](#docker-compose-éƒ¨ç½²)
- [äº‘å¹³å°éƒ¨ç½²](#äº‘å¹³å°éƒ¨ç½²)
- [é…ç½®ç®¡ç†](#é…ç½®ç®¡ç†)
- [æ•°æ®åº“åˆå§‹åŒ–](#æ•°æ®åº“åˆå§‹åŒ–)
- [ç›‘æ§å’Œæ—¥å¿—](#ç›‘æ§å’Œæ—¥å¿—)
- [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)
- [å®‰å…¨åŠ å›º](#å®‰å…¨åŠ å›º)

---

## éƒ¨ç½²æ–¹å¼

æœ¬æ–‡æ¡£æä¾›ä»¥ä¸‹éƒ¨ç½²æ–¹å¼ï¼š

1. **æœ¬åœ°å¼€å‘éƒ¨ç½²** - é€‚åˆå¼€å‘æµ‹è¯•
2. **Docker éƒ¨ç½²** - é€‚åˆå°å‹ç”Ÿäº§ç¯å¢ƒ
3. **Docker Compose éƒ¨ç½²** - é€‚åˆå®Œæ•´çš„ç”Ÿäº§ç¯å¢ƒ
4. **äº‘å¹³å°éƒ¨ç½²** - é€‚åˆäº‘åŸç”Ÿéƒ¨ç½²

---

## ç¯å¢ƒå‡†å¤‡

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux/macOS/Windows (æ¨è Linux)
- **Node.js**: >= 18.0.0
- **npm**: >= 9.0.0
- **Docker**: >= 20.10 (å¦‚æœä½¿ç”¨ Docker éƒ¨ç½²)
- **Docker Compose**: >= 2.0 (å¦‚æœä½¿ç”¨ Docker Compose)
- **PostgreSQL**: >= 14 (é€šè¿‡ Supabase æä¾›)

### ä¾èµ–æœåŠ¡

- **Supabase** - æ•°æ®åº“å’Œè®¤è¯æœåŠ¡
- **AI æä¾›å•†** - GitCodeã€DashScopeã€ModelScope ç­‰
- **MCP æœåŠ¡å™¨** - 12306ã€é«˜å¾·åœ°å›¾ã€Bing ç­‰

---

## æœ¬åœ°å¼€å‘éƒ¨ç½²

### 1. å…‹éš†é¡¹ç›®

```bash
git clone <your-repo-url>
cd ai-travel-planner
```

### 2. å®‰è£…ä¾èµ–

```bash
cd backend
npm install
```

### 3. é…ç½®ç¯å¢ƒå˜é‡

```bash
# å¤åˆ¶ç¯å¢ƒå˜é‡æ¨¡æ¿
cp .env.example .env

# ç¼–è¾‘ .env æ–‡ä»¶
# å¡«å…¥å¿…è¦çš„é…ç½®ä¿¡æ¯
```

### 4. é…ç½® Supabase

```bash
# åœ¨ Supabase æ§åˆ¶å°åˆ›å»ºé¡¹ç›®
# æ‰§è¡Œ supabase-setup.sql åˆå§‹åŒ–æ•°æ®åº“
# å¤åˆ¶é¡¹ç›® URL å’Œ Keys åˆ° .env æ–‡ä»¶
```

### 5. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ï¼ˆæ”¯æŒçƒ­é‡è½½ï¼‰
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start
```

### 6. éªŒè¯éƒ¨ç½²

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:3001/health

# æŸ¥çœ‹æ—¥å¿—
# æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°
```

---

## Docker éƒ¨ç½²

### 1. æ„å»ºé•œåƒï¼ˆå•é•œåƒåŒæ—¶æœåŠ¡å‰ç«¯ä¸åç«¯ï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•ï¼ˆåŒ…å« Dockerfileï¼‰
docker build -t ai-travel-planner:latest .
```

### 2. è¿è¡Œå®¹å™¨ï¼ˆä» env-file æ³¨å…¥é…ç½®ï¼‰

```bash
docker run -d \
  --name ai-travel-planner \
  -p 3002:3002 \
  --env-file backend/.env \
  --restart unless-stopped \
  ai-travel-planner:latest
```

### 3. éªŒè¯éƒ¨ç½²

```bash
# æŸ¥çœ‹å®¹å™¨çŠ¶æ€
docker ps --filter "name=ai-travel-planner"

# æŸ¥çœ‹æ—¥å¿—
docker logs -f ai-travel-planner

# å¥åº·æ£€æŸ¥
curl http://localhost:3002/health
```

### 4. å¸¸ç”¨ Docker å‘½ä»¤

```bash
# åœæ­¢å®¹å™¨
docker stop ai-travel-planner

# å¯åŠ¨å®¹å™¨
docker start ai-travel-planner

# é‡å¯å®¹å™¨
docker restart ai-travel-planner

# åˆ é™¤å®¹å™¨
docker rm ai-travel-planner

# è¿›å…¥å®¹å™¨
docker exec -it ai-travel-planner sh
```

---

## Docker Compose éƒ¨ç½²

### 1. ä½¿ç”¨æ ¹ç›®å½• docker-compose.ymlï¼ˆå•æœåŠ¡ï¼‰

é¡¹ç›®å·²å†…ç½®ï¼š

```yaml
services:
  app:
    build: .
    image: ai-travel-planner:latest
    ports:
      - "3002:3002"
    env_file:
      - backend/.env
```

### 2. å¯åŠ¨æœåŠ¡

```bash
# æ„å»ºå¹¶å¯åŠ¨ï¼ˆCompose V2ï¼‰
docker compose up -d

# æŸ¥çœ‹çŠ¶æ€
docker compose ps

# æŸ¥çœ‹æ—¥å¿—
docker compose logs -f app
```

### 3. åœæ­¢æœåŠ¡

```bash
# åœæ­¢æ‰€æœ‰æœåŠ¡
docker compose down

# åœæ­¢å¹¶åˆ é™¤å·
docker compose down -v
```

### 4. æ›´æ–°æœåŠ¡

```bash
# é‡æ–°æ„å»ºé•œåƒ
docker compose up -d --build

# é‡å¯æœåŠ¡
docker compose restart app
```

---

## äº‘å¹³å°éƒ¨ç½²

### ModelScopeï¼ˆä½¿ç”¨ Node é•œåƒï¼‰

#### 1. åŸç†
- å®¹å™¨éœ€ç›‘å¬ `0.0.0.0:7860`ï¼Œå¹³å°å°†è¯¥ç«¯å£æ˜ å°„åˆ°å¤–ç½‘ã€‚
- æœ¬é¡¹ç›®åç«¯è¯»å–ç¯å¢ƒå˜é‡ `PORT` / `HOST`ï¼Œæ— é¡»æ”¹ä»£ç å³å¯åˆ‡æ¢ç«¯å£ã€‚

#### 2. æ–‡ä»¶å‡†å¤‡
- ä¿æŒæ ¹ç›®å½• Dockerfileï¼ˆå¤šé˜¶æ®µæ„å»ºï¼Œå‰ç«¯äº§ç‰©å¤åˆ¶åˆ° `/app/public`ï¼Œåç«¯æä¾›é™æ€ä¸ APIï¼‰ã€‚
- æ¨é€å®Œæ•´ä»£ç åˆ° ModelScope ç©ºé—´ä»“åº“ã€‚

#### 3. å¹³å°ç¯å¢ƒå˜é‡
- å¿…å¡«ï¼š`PORT=7860`ã€`HOST=0.0.0.0`
- Supabaseï¼š`SUPABASE_URL`ã€`SUPABASE_SERVICE_ROLE_KEY`ã€`SUPABASE_ANON_KEY`
- AI é…ç½®ï¼š`AI_TEXT_PROVIDERS_JSON`ã€`AI_IMAGE_PROVIDERS_JSON`
- åœ°å›¾ï¼š`AMAP_KEY`ã€`AMAP_SECURITY_CODE`ã€`AMAP_REST_KEY`
- MCPï¼š`MCP_12306_URL` / `MCP_12306_TOKEN`ã€`MCP_AMAP_URL` / `MCP_AMAP_AUTHORIZATION`ã€`MCP_BING_URL` / `MCP_BING_TOKEN`

#### 4. æ„å»ºä¸è®¿é—®
- è§¦å‘ç©ºé—´æ„å»ºï¼Œç­‰å¾…å®Œæˆã€‚
- å¹³å°ä¼šæä¾›å¤–ç½‘ URLï¼Œç›´æ¥è®¿é—®å³å¯ã€‚

#### 5. å¸¸è§é—®é¢˜
- ç«¯å£ä¸é€šï¼šæœªè®¾ç½® `PORT=7860` æˆ– `HOST=0.0.0.0`ã€‚
- å‰ç«¯ç©ºç™½ï¼šåç«¯æœªæä¾›é™æ€ç›®å½•ï¼›æœ¬é¡¹ç›®å·²å†…ç½® `/app/public` é™æ€æœåŠ¡ä¸ SPA å…œåº•è·¯ç”±ã€‚
- env-file è§£æé”™è¯¯ï¼šDocker çš„ `--env-file` ä¸æ”¯æŒå¤šè¡Œ JSONï¼Œè¯·å°† JSON å‹æˆå•è¡Œæˆ–ä½¿ç”¨ `-e` æ³¨å…¥ã€‚

### è…¾è®¯äº‘ Lighthouse

#### 1. è´­ä¹°æœåŠ¡å™¨

- é€‰æ‹©æ“ä½œç³»ç»Ÿï¼šUbuntu 20.04/22.04 LTS
- é…ç½®å»ºè®®ï¼š2æ ¸4GB æˆ–æ›´é«˜
- å¸¦å®½ï¼š3Mbps æˆ–æ›´é«˜

#### 2. é…ç½®æœåŠ¡å™¨

```bash
# æ›´æ–°ç³»ç»Ÿ
sudo apt update && sudo apt upgrade -y

# å®‰è£… Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt install -y nodejs

# å®‰è£… Docker
curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh

# å®‰è£… Docker Compose
sudo apt install docker-compose-plugin

# éªŒè¯å®‰è£…
node --version
docker --version
```

#### 3. éƒ¨ç½²åº”ç”¨

```bash
# å…‹éš†é¡¹ç›®
git clone <your-repo-url>
cd ai-travel-planner

# é…ç½®ç¯å¢ƒå˜é‡
cp backend/.env.example backend/.env
nano backend/.env

# ä½¿ç”¨ Docker Compose å¯åŠ¨
docker-compose up -d
```

#### 4. é…ç½® Nginxï¼ˆå¯é€‰ï¼‰

```bash
# å®‰è£… Nginx
sudo apt install nginx

# é…ç½® Nginx åå‘ä»£ç†
sudo nano /etc/nginx/sites-available/ai-travel
```

```nginx
server {
    listen 80;
    server_name your-domain.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

```bash
# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/ai-travel /etc/nginx/sites-enabled/

# æµ‹è¯•é…ç½®
sudo nginx -t

# é‡å¯ Nginx
sudo systemctl restart nginx
```

#### 5. é…ç½® SSLï¼ˆä½¿ç”¨ Let's Encryptï¼‰

```bash
# å®‰è£… Certbot
sudo apt install certbot python3-certbot-nginx

# è·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

### CloudBase (è…¾è®¯äº‘)

#### 1. åˆ›å»º CloudBase é¡¹ç›®

1. ç™»å½• [è…¾è®¯äº‘ CloudBase æ§åˆ¶å°](https://console.cloud.tencent.com/tcb)
2. åˆ›å»ºæ–°é¡¹ç›®
3. é€‰æ‹©ç¯å¢ƒï¼šæµ·å¤–ç‰ˆï¼ˆå¦‚æœéœ€è¦è®¿é—®å›½å¤– AI æœåŠ¡ï¼‰

#### 2. åˆå§‹åŒ–é¡¹ç›®

```bash
# å®‰è£… CloudBase CLI
npm install -g @cloudbase/cli

# ç™»å½•
cloudbase login

# åˆå§‹åŒ–
cloudbase init
```

#### 3. é…ç½® cloudbaserc.json

```json
{
  "envId": "your-env-id",
  "version": "2.0",
  "$schema": "https://framework-1258016615.tcloudbaseapp.com/schema/latest.json",
  "framework": {
    "name": "ai-travel-planner",
    "plugins": {
      "function": {
        "use": "@cloudbase/framework-plugin-function",
        "inputs": {
          "functionRoot": "./backend",
          "functions": [
            {
              "name": "api",
              "description": "API æœåŠ¡",
              "runtime": "Nodejs16.13",
              "handler": "index.js",
              "timeout": 60,
              "memorySize": 512,
              "envVariables": {
                "NODE_ENV": "production"
              }
            }
          ]
        }
      }
    }
  }
}
```

#### 4. éƒ¨ç½²

```bash
# éƒ¨ç½²åˆ° CloudBase
cloudbase deploy
```

---

## é…ç½®ç®¡ç†

### ç¯å¢ƒå˜é‡æ¸…å•

#### å¿…éœ€é…ç½®

```bash
# æœåŠ¡å™¨é…ç½®
PORT=3001
HOST=0.0.0.0
NODE_ENV=production

# AI æ–‡æœ¬æä¾›å•†ï¼ˆJSON æ ¼å¼ï¼‰
AI_TEXT_PROVIDERS_JSON='[
  {
    "name": "gitcode",
    "enabled": true,
    "baseURL": "https://api.gitcode.com/api/v5",
    "apiKey": "sk-xxx",
    "model": "Kimi-K2",
    "priority": 1
  }
]'

# Supabase é…ç½®
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_SERVICE_ROLE_KEY=eyJxxx...

# å‰ç«¯å…¬å¼€é…ç½®
PUBLIC_SUPABASE_URL=https://xxx.supabase.co
PUBLIC_SUPABASE_ANON_KEY=eyJxxx...

# é«˜å¾·åœ°å›¾
PUBLIC_AMAP_KEY=xxx
PUBLIC_AMAP_REST_KEY=yyy
```

#### å¯é€‰é…ç½®

```bash
# AI å›¾ç‰‡æä¾›å•†
AI_IMAGE_PROVIDERS_JSON='[
  {
    "name": "modelscope",
    "enabled": true,
    "apiKey": "xxx",
    "priority": 1
  }
]'

# MCP å·¥å…·é…ç½®
MCP_12306_URL=https://mcp.api-inference.modelscope.net/xxx/sse
MCP_12306_AUTHORIZATION=Bearer xxx
MCP_AMAP_URL=xxx
MCP_AMAP_AUTHORIZATION=Bearer xxx
MCP_BING_URL=xxx
MCP_BING_AUTHORIZATION=Bearer xxx

# CORS é…ç½®
CORS_ORIGIN=https://your-domain.com

# è°ƒè¯•æ¨¡å¼
AI_CHAT_DEBUG=0

# MCP é…ç½®ï¼ˆJSON æ ¼å¼ï¼‰
MCP_SERVERS_JSON='{
  "custom-server": {
    "url": "https://...",
    "transport": "sse",
    "headers": {
      "Authorization": "Bearer xxx"
    }
  }
}'
```

### é…ç½®æœ€ä½³å®è·µ

1. **å®‰å…¨ç¬¬ä¸€**
   - ä½¿ç”¨ `.env` æ–‡ä»¶å­˜å‚¨æ•æ„Ÿä¿¡æ¯
   - ä¸è¦æäº¤ `.env` åˆ°ç‰ˆæœ¬æ§åˆ¶
   - ä½¿ç”¨å¼ºå¯†ç å’Œ API å¯†é’¥

2. **ç¯å¢ƒéš”ç¦»**
   - å¼€å‘ç¯å¢ƒï¼š`.env.development`
   - æµ‹è¯•ç¯å¢ƒï¼š`.env.test`
   - ç”Ÿäº§ç¯å¢ƒï¼š`.env.production`

3. **é…ç½®éªŒè¯**
   - å¯åŠ¨å‰éªŒè¯æ‰€æœ‰å¿…éœ€çš„é…ç½®é¡¹
   - ä½¿ç”¨é»˜è®¤å€¼å’Œé…ç½®æ¨¡æ¿
   - æä¾›æ¸…æ™°çš„é”™è¯¯æç¤º

---

## æ•°æ®åº“åˆå§‹åŒ–

### Supabase é…ç½®

#### 1. åˆ›å»º Supabase é¡¹ç›®

1. è®¿é—® [Supabase](https://supabase.com/)
2. æ³¨å†Œå¹¶åˆ›å»ºæ–°é¡¹ç›®
3. è®°å½•é¡¹ç›® URL å’Œ Keys

#### 2. æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬

åœ¨ Supabase æ§åˆ¶å°çš„ SQL Editor ä¸­æ‰§è¡Œ `supabase-setup.sql`ï¼š

```sql
-- ç”¨æˆ·è¡¨
CREATE TABLE IF NOT EXISTS users (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  email TEXT UNIQUE NOT NULL,
  display_name TEXT
);

-- æ—…è¡Œè®¡åˆ’è¡¨
CREATE TABLE IF NOT EXISTS travel_plans (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title TEXT NOT NULL,
  destination TEXT NOT NULL,
  days INTEGER NOT NULL,
  budget NUMERIC,
  people INTEGER,
  preferences TEXT,
  itinerary JSONB,
  budget_breakdown JSONB,
  tips JSONB
);

-- AI èŠå¤©ä¼šè¯è¡¨
CREATE TABLE IF NOT EXISTS chat_sessions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  user_id UUID REFERENCES users(id) ON DELETE CASCADE,
  title TEXT,
  messages JSONB,
  meta JSONB
);

-- åˆ›å»ºç´¢å¼•
CREATE INDEX idx_travel_plans_user_id ON travel_plans(user_id);
CREATE INDEX idx_chat_sessions_user_id ON chat_sessions(user_id);

-- å¯ç”¨è¡Œçº§å®‰å…¨
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE travel_plans ENABLE ROW LEVEL SECURITY;
ALTER TABLE chat_sessions ENABLE ROW LEVEL SECURITY;

-- åˆ›å»º RLS ç­–ç•¥
CREATE POLICY "Users can view their own data" ON users
  FOR SELECT USING (auth.uid() = id);

CREATE POLICY "Users can insert their own data" ON users
  FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can view their own travel plans" ON travel_plans
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own travel plans" ON travel_plans
  FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own travel plans" ON travel_plans
  FOR UPDATE USING (auth.uid() = user_id);

CREATE POLICY "Users can delete their own travel plans" ON travel_plans
  FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view their own chat sessions" ON chat_sessions
  FOR SELECT USING (auth.uid() = user_id);

CREATE POLICY "Users can create their own chat sessions" ON chat_sessions
  FOR INSERT WITH CHECK (auth.uid() = user_id);
```

---

## ç›‘æ§å’Œæ—¥å¿—

### æ—¥å¿—ç®¡ç†

#### 1. åº”ç”¨æ—¥å¿—

```javascript
// æ—¥å¿—çº§åˆ«
- info: ä¸€èˆ¬ä¿¡æ¯
- warn: è­¦å‘Šä¿¡æ¯
- error: é”™è¯¯ä¿¡æ¯
- debug: è°ƒè¯•ä¿¡æ¯ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰
```

#### 2. æ—¥å¿—æŸ¥çœ‹

```bash
# Docker å•å®¹å™¨
docker logs -f ai-travel-planner

# Docker Compose
docker compose logs -f app

# æœ¬åœ°éƒ¨ç½²
# æ—¥å¿—è¾“å‡ºåˆ°æ§åˆ¶å°
```

#### 2.1 MCP å¯åŠ¨ä¸æ•…éšœæ’æŸ¥

```bash
# æŸ¥çœ‹æœ€è¿‘ 200 è¡Œæ—¥å¿—å¹¶ç­› MCP ç›¸å…³
docker compose logs --tail=200 app | Select-String "MCP servers"
docker compose logs --tail=200 app | Select-String "MCP.*failed"
docker compose logs --tail=200 app | Select-String "provider.probe"
```

- æ­£å¸¸æ—¥å¿—ï¼š
  - `MCP servers ready: 12306-mcp(tools:N), bing-cn-mcp-server(tools:M), amap-maps(tools:K)`
- å¼‚å¸¸æ—¥å¿—ï¼š
  - `MCP servers failed: name(error)` â†’ æ£€æŸ¥å¯¹åº”ç¯å¢ƒå˜é‡çš„ URL å’Œ Token
  - `provider.probe_err` â†’ å¯èƒ½æ˜¯ç½‘ç»œä¸å¯è¾¾æˆ–é‰´æƒé”™è¯¯
- æ’æŸ¥å»ºè®®ï¼š
  - æ ¡éªŒ `MCP_*` å˜é‡æ˜¯å¦åŒ¹é…å¹³å°ç»™å‡ºçš„åœ°å€ä¸ä»¤ç‰Œæ ¼å¼ï¼ˆ`Authorization: Bearer <token>`ï¼‰
  - ç¡®è®¤å¹³å°ç½‘ç»œå¯è®¿é—®ç›¸å…³ SSE/HTTP ç«¯ç‚¹
  - æš‚æ—¶ç¦ç”¨é—®é¢˜æœåŠ¡å™¨ï¼šæ¸…ç†æˆ–è°ƒæ•´ `MCP_SERVERS_JSON` / å•ä¸ª `MCP_*` å˜é‡

#### 3. æ—¥å¿—æ”¶é›†

æ¨èä½¿ç”¨æ—¥å¿—æ”¶é›†å·¥å…·ï¼š

- **Loki** - è½»é‡çº§æ—¥å¿—èšåˆ
- **ELK Stack** - Elasticsearch, Logstash, Kibana
- **CloudWatch** - AWS äº‘ç›‘æ§
- **è…¾è®¯äº‘ CLS** - è…¾è®¯äº‘æ—¥å¿—æœåŠ¡

### ç›‘æ§æŒ‡æ ‡

#### 1. åº”ç”¨å¥åº·æ£€æŸ¥

```bash
# å¥åº·æ£€æŸ¥ç«¯ç‚¹
GET /health

# å“åº”ç¤ºä¾‹
{
  "status": "ok",
  "timestamp": "2025-01-20T10:00:00.000Z",
  "providers": {
    "text": 2,
    "image": 1
  }
}
```

#### 2. å…³é”®æŒ‡æ ‡

- **è¯·æ±‚å»¶è¿Ÿ** - API å“åº”æ—¶é—´
- **é”™è¯¯ç‡** - å¤±è´¥è¯·æ±‚æ¯”ä¾‹
- **ååé‡** - æ¯ç§’è¯·æ±‚æ•° (QPS)
- **AI è°ƒç”¨æˆåŠŸç‡** - æä¾›å•†è°ƒç”¨æˆåŠŸç‡
- **èµ„æºä½¿ç”¨ç‡** - CPUã€å†…å­˜ã€ç£ç›˜ä½¿ç”¨

#### 3. ç›‘æ§å·¥å…·æ¨è

- **Prometheus + Grafana** - å¼€æºç›‘æ§æ–¹æ¡ˆ
- **Datadog** - å•†ä¸šç›‘æ§å¹³å°
- **New Relic** - APM ç›‘æ§
- **è…¾è®¯äº‘ç›‘æ§** - äº‘åŸç”Ÿç›‘æ§

---

## æ€§èƒ½ä¼˜åŒ–

### 1. åº”ç”¨å±‚ä¼˜åŒ–

#### è¿æ¥æ± é…ç½®

```javascript
// Supabase è¿æ¥æ± 
const supabase = createClient(
  process.env.SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY,
  {
    db: {
      schema: 'public',
      poolSize: 10
    }
  }
);
```

#### ç¼“å­˜ç­–ç•¥

```javascript
// å¯ç”¨ Redis ç¼“å­˜ï¼ˆæ¨èï¼‰
const redis = require('redis');
const client = redis.createClient();

// ç¼“å­˜ AI å“åº”
async function getCachedResponse(key) {
  const cached = await client.get(key);
  return cached ? JSON.parse(cached) : null;
}

async function setCachedResponse(key, value, ttl = 3600) {
  await client.setex(key, ttl, JSON.stringify(value));
}
```

### 2. AI è°ƒç”¨ä¼˜åŒ–

#### æä¾›å•†é€‰æ‹©

```javascript
// é…ç½®å¤šä¸ªæä¾›å•†å¹¶è®¾ç½®ä¼˜å…ˆçº§
AI_TEXT_PROVIDERS_JSON='[
  {"name": "provider1", "priority": 1},
  {"name": "provider2", "priority": 2}
]'
```

#### è¯·æ±‚æ‰¹å¤„ç†

```javascript
// æ‰¹é‡å¤„ç†è¯·æ±‚
const batchRequests = async (requests) => {
  return Promise.allSettled(requests.map(req => processRequest(req)));
};
```

### 3. æ•°æ®åº“ä¼˜åŒ–

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- åˆ›å»ºåˆé€‚çš„ç´¢å¼•
CREATE INDEX idx_travel_plans_user_created ON travel_plans(user_id, created_at DESC);
CREATE INDEX idx_chat_sessions_user_updated ON chat_sessions(user_id, updated_at DESC);
```

#### æŸ¥è¯¢ä¼˜åŒ–

```javascript
// ä½¿ç”¨åˆ†é¡µæŸ¥è¯¢
const { data, error } = await supabase
  .from('travel_plans')
  .select('*')
  .eq('user_id', userId)
  .range(from, to)
  .order('created_at', { ascending: false });
```

### 4. ç½‘ç»œä¼˜åŒ–

#### CDN é…ç½®

```bash
# ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº
# å›¾ç‰‡ã€éŸ³é¢‘ç­‰æ–‡ä»¶ä½¿ç”¨ CDN åˆ†å‘
```

#### å‹ç¼©é…ç½®

```javascript
// å¯ç”¨ gzip å‹ç¼©
const compression = require('compression');
app.use(compression());
```

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. æœåŠ¡æ— æ³•å¯åŠ¨

**é—®é¢˜ï¼š**
```bash
Error: listen EADDRINUSE: address already in use :::3001
```

**è§£å†³æ–¹æ¡ˆï¼š**
```bash
# æŸ¥æ‰¾å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -i :3001

# ç»ˆæ­¢è¿›ç¨‹
kill -9 <PID>
```

#### 2. æ•°æ®åº“è¿æ¥å¤±è´¥

**é—®é¢˜ï¼š**
```bash
Error: connect ECONNREFUSED
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ Supabase URL å’Œ Key æ˜¯å¦æ­£ç¡®
- ç¡®è®¤æ•°æ®åº“æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
- æ£€æŸ¥ç½‘ç»œè¿æ¥

#### 3. AI è°ƒç”¨å¤±è´¥

**é—®é¢˜ï¼š**
```bash
Error: MODEL_INVOKE_FAILED
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ API å¯†é’¥æ˜¯å¦æ­£ç¡®
- ç¡®è®¤è´¦æˆ·ä½™é¢æ˜¯å¦å……è¶³
- æŸ¥çœ‹æä¾›å•†çŠ¶æ€
- æ£€æŸ¥ç½‘ç»œè¿æ¥

#### 4. MCP å·¥å…·è°ƒç”¨å¤±è´¥

**é—®é¢˜ï¼š**
```bash
Error: MCP_TIMEOUT
```

**è§£å†³æ–¹æ¡ˆï¼š**
- æ£€æŸ¥ MCP æœåŠ¡å™¨ URL
- ç¡®è®¤æˆæƒä¿¡æ¯æ˜¯å¦æ­£ç¡®
- å¢åŠ è¶…æ—¶æ—¶é—´
- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—

### è°ƒè¯•æŠ€å·§

#### 1. å¯ç”¨è°ƒè¯•æ¨¡å¼

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
AI_CHAT_DEBUG=1 npm start
```

#### 2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# Docker éƒ¨ç½²
docker logs --tail 100 -f ai-travel-backend

# æœ¬åœ°éƒ¨ç½²
npm start 2>&1 | tee app.log
```

#### 3. ä½¿ç”¨ç›‘æ§å·¥å…·

```bash
# ä½¿ç”¨ htop ç›‘æ§èµ„æºä½¿ç”¨
htop

# ä½¿ç”¨ netstat ç›‘æ§ç½‘ç»œ
netstat -tulpn
```

---

## å®‰å…¨åŠ å›º

### 1. ç½‘ç»œå®‰å…¨

#### é˜²ç«å¢™é…ç½®

```bash
# Ubuntu UFW
sudo ufw allow 22/tcp    # SSH
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw enable
```

#### HTTPS é…ç½®

```bash
# ä½¿ç”¨ Let's Encrypt
sudo certbot --nginx -d your-domain.com
```

### 2. åº”ç”¨å®‰å…¨

#### API å¯†é’¥ç®¡ç†

```bash
# ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å¯†é’¥
# ä½¿ç”¨ç¯å¢ƒå˜é‡
# å®šæœŸæ›´æ¢å¯†é’¥
```

#### é€Ÿç‡é™åˆ¶

```javascript
// ä½¿ç”¨ express-rate-limit
const rateLimit = require('express-rate-limit');

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 åˆ†é’Ÿ
  max: 100 // æ¯ä¸ªçª—å£æœŸæœ€å¤š 100 ä¸ªè¯·æ±‚
});

app.use('/api/', limiter);
```

### 3. æ•°æ®å®‰å…¨

#### å¤‡ä»½ç­–ç•¥

```bash
# å®šæœŸå¤‡ä»½æ•°æ®åº“
# Supabase æä¾›è‡ªåŠ¨å¤‡ä»½
```

#### æ•æ„Ÿæ•°æ®åŠ å¯†

```javascript
// ä½¿ç”¨åŠ å¯†å­˜å‚¨æ•æ„Ÿæ•°æ®
const crypto = require('crypto');

function encrypt(text, key) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipheriv('aes-256-cbc', key, iv);
  return cipher.update(text, 'utf8', 'hex') + cipher.final('hex');
}
```

### 4. è®¿é—®æ§åˆ¶

#### CORS é…ç½®

```javascript
// é™åˆ¶å…è®¸çš„æº
cors: {
  origin: ['https://your-domain.com'],
  credentials: true
}
```

#### è®¤è¯å’Œæˆæƒ

```javascript
// å®ç° JWT è®¤è¯
const jwt = require('jsonwebtoken');

function verifyToken(req, res, next) {
  const token = req.headers.authorization;

  if (!token) {
    return res.status(401).json({ error: 'No token provided' });
  }

  jwt.verify(token, SECRET_KEY, (err, decoded) => {
    if (err) {
      return res.status(403).json({ error: 'Invalid token' });
    }
    req.userId = decoded.id;
    next();
  });
}
```

---

## æ›´æ–°å’Œç»´æŠ¤

### ç‰ˆæœ¬å‡çº§

```bash
# æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# æ›´æ–°ä¾èµ–
cd backend
npm install

# é‡æ–°æ„å»º Docker é•œåƒ
docker-compose build --no-cache backend

# é‡å¯æœåŠ¡
docker-compose up -d backend
```

### æ•°æ®è¿ç§»

```sql
-- åˆ›å»ºè¿ç§»è„šæœ¬
-- åœ¨ Supabase SQL Editor ä¸­æ‰§è¡Œ
```

### å›æ»šç­–ç•¥

```bash
# Git å›æ»š
git checkout <previous-commit>
docker-compose up -d --force-recreate backend

# æ•°æ®åº“å›æ»š
-- ä½¿ç”¨ Supabase çš„æ—¶é—´ç‚¹æ¢å¤åŠŸèƒ½
```

---

## æˆæœ¬ä¼˜åŒ–

### 1. æœåŠ¡å™¨æˆæœ¬

- é€‰æ‹©åˆé€‚çš„é…ç½®
- ä½¿ç”¨é¢„ç•™å®ä¾‹
- ä¼˜åŒ–èµ„æºä½¿ç”¨

### 2. AI è°ƒç”¨æˆæœ¬

- é€‰æ‹©æ€§ä»·æ¯”é«˜çš„æä¾›å•†
- å®ç°ç¼“å­˜å‡å°‘è°ƒç”¨
- ä¼˜åŒ–æç¤ºè¯å‡å°‘ token ä½¿ç”¨

### 3. å­˜å‚¨æˆæœ¬

- å®šæœŸæ¸…ç†è¿‡æœŸæ•°æ®
- ä½¿ç”¨ CDN åˆ†å‘é™æ€èµ„æº
- å‹ç¼©å›¾ç‰‡å’ŒéŸ³é¢‘æ–‡ä»¶

---

## æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†å®Œæ•´çš„éƒ¨ç½²æŒ‡å—ï¼ŒåŒ…æ‹¬ï¼š

- âœ… å¤šç§éƒ¨ç½²æ–¹å¼
- âœ… è¯¦ç»†çš„é…ç½®è¯´æ˜
- âœ… ç›‘æ§å’Œæ—¥å¿—ç®¡ç†
- âœ… æ€§èƒ½ä¼˜åŒ–å»ºè®®
- âœ… æ•…éšœæ’æŸ¥æ–¹æ³•
- âœ… å®‰å…¨åŠ å›ºæªæ–½

æ ¹æ®æ‚¨çš„å®é™…éœ€æ±‚é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ–¹å¼ï¼Œå¹¶æŒ‰ç…§æ–‡æ¡£è¿›è¡Œé…ç½®å’Œä¼˜åŒ–ã€‚

---

**æœ€åæ›´æ–°ï¼š2025-01-20**
